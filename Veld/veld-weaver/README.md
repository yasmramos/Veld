# Veld Weaver

Bytecode weaving plugin for private field injection support in Veld DI framework.

## Overview

Veld Weaver is a Maven plugin that transforms compiled classes to add synthetic setter methods for private fields annotated with `@Inject` or `@Value`. This enables dependency injection into private fields **without using reflection**.

## How It Works

```
                    Compilation Pipeline
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   .java      │───>│   javac      │───>│   .class     │
│   source     │    │   compile    │    │   (original) │
└──────────────┘    └──────────────┘    └──────┬───────┘
                                               │
                                               ▼
                                    ┌──────────────────┐
                                    │   veld-weaver    │
                                    │   (ASM weaving)  │
                                    └──────────┬───────┘
                                               │
                                               ▼
                                    ┌──────────────────┐
                                    │   .class         │
                                    │   (with setters) │
                                    └──────────────────┘
```

### Before Weaving

```java
@Singleton
public class MyService {
    @Inject
    private Repository repository;  // Private field
}
```

### After Weaving

```java
@Singleton
public class MyService {
    @Inject
    private Repository repository;
    
    // Generated synthetic setter (public synthetic)
    public synthetic void __di_set_repository(Repository value) {
        this.repository = value;
    }
}
```

### Factory Uses Setter

```java
// Generated factory calls synthetic setter
public class MyService$$VeldFactory implements ComponentFactory<MyService> {
    public MyService create(Veld container) {
        MyService instance = new MyService();
        instance.__di_set_repository(Veld.get(Repository.class));
        return instance;
    }
}
```

## Usage

Add the plugin to your `pom.xml`:

```xml
<build>
    <plugins>
        <!-- Standard annotation processing -->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-compiler-plugin</artifactId>
            <configuration>
                <annotationProcessorPaths>
                    <path>
                        <groupId>io.github.yasmramos.veld</groupId>
                        <artifactId>veld-processor</artifactId>
                        <version>${veld.version}</version>
                    </path>
                </annotationProcessorPaths>
            </configuration>
        </plugin>
        
        <!-- Bytecode weaving for private field injection -->
        <plugin>
            <groupId>io.github.yasmramos.veld</groupId>
            <artifactId>veld-weaver</artifactId>
            <version>${veld.version}</version>
            <executions>
                <execution>
                    <goals>
                        <goal>weave</goal>
                    </goals>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>
```

## Configuration

| Property | Default | Description |
|----------|---------|-------------|
| `veld.weaver.skip` | `false` | Skip weaving entirely |
| `veld.weaver.verbose` | `false` | Show detailed output |

## Supported Annotations

The weaver processes fields with these annotations:

- `@io.github.yasmramos.veld.annotation.Inject`
- `@javax.inject.Inject`
- `@jakarta.inject.Inject`
- `@io.github.yasmramos.veld.annotation.Value`

## Field Visibility Rules

| Field Visibility | Weaving Required | Injection Method |
|-----------------|------------------|------------------|
| `private` | Yes | Synthetic setter |
| `package-private` | No | Direct PUTFIELD |
| `protected` | No | Direct PUTFIELD |
| `public` | No | Direct PUTFIELD |

## Why This Approach?

### Zero Reflection

Traditional DI frameworks use `Field.setAccessible(true)` to inject private fields. This has drawbacks:

- Security restrictions in modular Java (JPMS)
- Performance overhead
- Not compatible with GraalVM native-image without configuration

Veld Weaver generates synthetic setter methods at build time, enabling:

- Direct method invocation (no reflection)
- Full compatibility with Java modules
- Optimal runtime performance
- GraalVM native-image friendly

### Synthetic Methods

The generated methods are marked as `synthetic`, meaning:

- They don't appear in JavaDoc
- They're hidden from IDE autocomplete
- They're recognized as compiler-generated by tools

## Limitations

1. **Build-time only**: Weaving happens during compilation, not at runtime
2. **Final fields**: Cannot inject into `final` fields (use constructor injection)
3. **Static fields**: Cannot inject into `static` fields

## Comparison with Other Approaches

| Approach | Reflection | Build-time | Runtime Cost |
|----------|------------|------------|--------------|
| Field.setAccessible() | Yes | No | High |
| Lombok @Setter | No | Yes | None |
| **Veld Weaver** | No | Yes | None |
| Constructor injection | No | N/A | None |
