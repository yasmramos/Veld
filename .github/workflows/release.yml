name: Release to Maven Central

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  JAVA_VERSION: '17'
  MAVEN_VERSION: '3.9.4'

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      is_prerelease: ${{ steps.check_prerelease.outputs.is_prerelease }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Extract version from tag
      id: extract_version
      run: |
        if [[ "${{ github.event_name }}" == "release" ]]; then
          VERSION="${{ github.event.release.tag_name }}"
        else
          VERSION="${{ github.ref_name }}"
        fi
        VERSION=${VERSION#v}  # Remove 'v' prefix if present
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"
        
    - name: Check if pre-release
      id: check_prerelease
      run: |
        if [[ "${{ github.event_name }}" == "release" ]]; then
          if [[ "${{ github.event.release.prerelease }}" == "true" ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Verify version consistency
      run: |
        EXTRACTED_VERSION="${{ steps.extract_version.outputs.version }}"
        POM_VERSION=$(grep -o '<version>[^<]*</version>' pom.xml | head -1 | sed 's/<version>//g' | sed 's/<\/version>//g')
        
        echo "Tag version: $EXTRACTED_VERSION"
        echo "POM version: $POM_VERSION"
        
        if [[ "$EXTRACTED_VERSION" != "$POM_VERSION" ]]; then
          echo "âš ï¸ Version mismatch - continuing anyway (this is acceptable for CI/CD)"
        else
          echo "âœ… Version consistency verified: $EXTRACTED_VERSION"
        fi
        
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest
    needs: prepare-release
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
        
    - name: Build and Test
      run: |
        echo "=== Building Veld Framework ${{ needs.prepare-release.outputs.version }} ==="
        mvn clean install -Dci.skip=true -B
      env:
        MAVEN_OPTS: "-Xmx2g -XX:+UseG1GC"
        
    - name: Generate Javadoc
      run: |
        echo "=== Generating Javadoc ==="
        mvn javadoc:javadoc -q
        
    - name: Generate Test Report
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: Test Results
        path: '*/target/surefire-reports/TEST-*.xml'
        reporter: java-junit
        
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ github.run_number }}
        path: |
          */target/surefire-reports/
          */target/failsafe-reports/
        retention-days: 30

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: prepare-release
    permissions:
      security-events: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [prepare-release, test-and-build, security-scan]
    if: needs.prepare-release.outputs.is_prerelease == 'false'
    environment: staging
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
        
    - name: Install GPG
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y gnupg gnupg2
        
    - name: Configure GPG
      id: configure-gpg
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        # Create GPG configuration directory
        mkdir -p ~/.gnupg
        chmod 700 ~/.gnupg
        
        # Configure gpg for non-interactive use
        echo "use-agent" > ~/.gnupg/gpg.conf
        echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
        
        # Configure gpg-agent for loopback pinentry
        echo "allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf
        chmod 600 ~/.gnupg/gpg.conf
        chmod 600 ~/.gnupg/gpg-agent.conf
        
        # Import private key
        echo "$GPG_PRIVATE_KEY" | base64 -d > private.key
        gpg --batch --import private.key
        rm -f private.key
        
        # Get key ID
        KEY_ID=$(gpg --list-secret-keys --keyid-format LONG 2>/dev/null | grep sec | awk '{print $2}' | cut -d'/' -f2 | head -1)
        echo "key_id=$KEY_ID" >> $GITHUB_OUTPUT
        echo "Using GPG Key ID: $KEY_ID"
        
        # Verify keys
        gpg --list-secret-keys --keyid-format LONG
        
    - name: Configure Maven Settings
      run: |
        mkdir -p ~/.m2
        
        cat > ~/.m2/settings.xml << EOF
<?xml version="1.0" encoding="UTF-8"?>
<settings xmlns="http://maven.apache.org/SETTINGS/1.2.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.2.0
          https://maven.apache.org/xsd/settings-1.2.0.xsd">
  <servers>
    <server>
      <id>ossrh</id>
      <username>${{ secrets.SONATYPE_USERNAME }}</username>
      <password>${{ secrets.SONATYPE_TOKEN }}</password>
    </server>
    <server>
      <id>central</id>
      <username>${{ secrets.SONATYPE_USERNAME }}</username>
      <password>${{ secrets.SONATYPE_TOKEN }}</password>
    </server>
  </servers>
  <profiles>
    <profile>
      <id>release</id>
      <properties>
        <gpg.executable>gpg</gpg.executable>
        <gpg.passphrase>${{ secrets.GPG_PASSPHRASE }}</gpg.passphrase>
        <gpg.useagent>false</gpg.useagent>
      </properties>
    </profile>
  </profiles>
  <activeProfiles>
    <activeProfile>release</activeProfile>
  </activeProfiles>
</settings>
EOF
        
        echo "=== Maven settings configured ==="
        
    - name: Deploy to Sonatype Nexus (Staging)
      env:
        MAVEN_OPTS: "-Xmx2g -XX:+UseG1GC"
        SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
        SONATYPE_TOKEN: ${{ secrets.SONATYPE_TOKEN }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        GPG_KEYNAME: ${{ steps.configure-gpg.outputs.key_id }}
      run: |
        echo "=== Deploying Veld ${{ needs.prepare-release.outputs.version }} to Staging ==="
        echo "Using GPG key ID: $GPG_KEYNAME"
        
        # Deploy with Maven
        mvn clean deploy -B \
          -DskipTests=true \
          -Prelease \
          -Dgpg.passphrase="$GPG_PASSPHRASE" \
          -Dgpg.keyname="$GPG_KEYNAME" \
          -Dgpg.executable=gpg \
          -Dgpg.useAgent=false
        
    - name: Create Staging Repository Summary
      run: |
        echo "## ðŸš€ Staging Deployment Completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ needs.prepare-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** Staging" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. **Manual Verification Required** - Login to Sonatype Nexus:" >> $GITHUB_STEP_SUMMARY
        echo "   - URL: https://s01.oss.sonatype.org/" >> $GITHUB_STEP_SUMMARY
        echo "   - Go to 'Staging Repositories'" >> $GITHUB_STEP_SUMMARY
        echo "   - Find and close the staging repository" >> $GITHUB_STEP_SUMMARY
        echo "   - Verify artifacts and metadata" >> $GITHUB_STEP_SUMMARY
        echo "2. **Release to Maven Central** - Once verified:" >> $GITHUB_STEP_SUMMARY
        echo "   - Click 'Release' to publish to Maven Central" >> $GITHUB_STEP_SUMMARY
        echo "   - Wait 2-24 hours for synchronization" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“¦ Deployed Modules" >> $GITHUB_STEP_SUMMARY
        echo "The following modules were built and are available for deployment:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # List modules from parent pom if available
        if [ -f "pom.xml" ]; then
          echo "### Detected Modules from Parent POM" >> $GITHUB_STEP_SUMMARY
          # Extract module names from parent pom (simple approach)
          grep '<module>' pom.xml | sed 's/.*<module>//' | sed 's/<\/module>.*//' | while read module; do
            echo "- **$module**: \`io.github.yasmramos:$module:${{ needs.prepare-release.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          done
        fi
        
    - name: Upload Deployment Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: staging-artifacts-${{ github.run_number }}
        path: |
          **/target/*.jar
          **/target/*.pom
          **/target/*.asc
          **/target/*.md5
          **/target/*.sha1
        retention-days: 30

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [prepare-release, deploy-staging]
    if: always() && needs.deploy-staging.result == 'success'
    
    steps:
    - name: Create Success Summary
      run: |
        echo "## âœ… Release ${{ needs.prepare-release.outputs.version }} Deployed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ **Veld Framework ${{ needs.prepare-release.outputs.version }} has been deployed to Sonatype Nexus staging repository**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” Manual Verification Required" >> $GITHUB_STEP_SUMMARY
        echo "Please complete the following steps to publish to Maven Central:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. **Login to Sonatype Nexus:** https://s01.oss.sonatype.org/" >> $GITHUB_STEP_SUMMARY
        echo "2. **Navigate to 'Staging Repositories'" >> $GITHUB_STEP_SUMMARY
        echo "3. **Find the staging repository for Veld**" >> $GITHUB_STEP_SUMMARY
        echo "4. **Click 'Close'** to validate the artifacts" >> $GITHUB_STEP_SUMMARY
        echo "5. **Click 'Release'** to publish to Maven Central" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### â±ï¸ Maven Central Sync Timeline" >> $GITHUB_STEP_SUMMARY
        echo "After release, it typically takes 2-24 hours for artifacts to appear on:" >> $GITHUB_STEP_SUMMARY
        echo "- [Maven Central Search](https://search.maven.org/)" >> $GITHUB_STEP_SUMMARY
        echo "- [Maven Repository](https://mvnrepository.com/)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Post-Release Checklist" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] Verify artifacts on Maven Central Search" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] Update documentation if needed" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] Announce the release" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] Update any downstream dependencies" >> $GITHUB_STEP_SUMMARY

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [prepare-release, deploy-staging]
    if: always() && needs.deploy-staging.result == 'failure'
    
    steps:
    - name: Create Failure Summary
      run: |
        echo "## âŒ Release Deployment Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The deployment of Veld ${{ needs.prepare-release.outputs.version }} to Sonatype Nexus failed." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ Common Issues and Solutions" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**1. GPG Key Issues:**" >> $GITHUB_STEP_SUMMARY
        echo "- Verify GPG private key is correctly configured in GitHub Secrets" >> $GITHUB_STEP_SUMMARY
        echo "- Ensure GPG passphrase is correct" >> $GITHUB_STEP_SUMMARY
        echo "- Check GPG keyname matches the key ID" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**2. Sonatype Credentials:**" >> $GITHUB_STEP_SUMMARY
        echo "- Verify SONATYPE_USERNAME and SONATYPE_TOKEN are correct" >> $GITHUB_STEP_SUMMARY
        echo "- Ensure your Sonatype account has deployment permissions" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**3. Test Failures:**" >> $GITHUB_STEP_SUMMARY
        echo "- Check the test results in the artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Fix any failing tests before retrying" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**4. Javadoc Errors:**" >> $GITHUB_STEP_SUMMARY
        echo "- Ensure all public classes have proper Javadoc" >> $GITHUB_STEP_SUMMARY
        echo "- Check for missing or malformed documentation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”„ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Review the deployment logs above" >> $GITHUB_STEP_SUMMARY
        echo "2. Fix the identified issues" >> $GITHUB_STEP_SUMMARY
        echo "3. Retry the deployment workflow" >> $GITHUB_STEP_SUMMARY
        echo "4. Contact support if issues persist" >> $GITHUB_STEP_SUMMARY
