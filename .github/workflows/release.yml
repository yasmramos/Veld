name: Release to Maven Central

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  JAVA_VERSION: '17'

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      is_prerelease: ${{ steps.check_prerelease.outputs.is_prerelease }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Extract version from tag
      id: extract_version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        elif [[ "${{ github.event_name }}" == "release" ]]; then
          VERSION="${{ github.event.release.tag_name }}"
        else
          VERSION="${{ github.ref_name }}"
        fi
        VERSION=${VERSION#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"

    - name: Check if pre-release
      id: check_prerelease
      run: |
        if [[ "${{ github.event_name }}" == "release" ]]; then
          if [[ "${{ github.event.release.prerelease }}" == "true" ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi
        elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          # Manual releases are not prereleases by default
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
        else
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
        fi

    - name: Verify version consistency
      run: |
        EXTRACTED_VERSION="${{ steps.extract_version.outputs.version }}"
        POM_VERSION=$(grep -o '<version>[^<]*</version>' pom.xml | head -1 | sed 's/<version>//g' | sed 's/<\/version>//g')

        echo "Tag version: $EXTRACTED_VERSION"
        echo "POM version: $POM_VERSION"

        # Skip version check for manual deployments
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "Manual deployment - skipping version consistency check"
        elif [[ "$EXTRACTED_VERSION" != "$POM_VERSION" ]]; then
          echo "Version mismatch - continuing anyway"
        else
          echo "Version consistency verified: $EXTRACTED_VERSION"
        fi

    - name: Set project version for release
      id: set-version
      run: |
        VERSION="${{ steps.extract_version.outputs.version }}"
        echo "Setting project version to: $VERSION"
        mvn versions:set -DnewVersion=$VERSION -DgenerateBackupPoms=false -q
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Show updated pom.xml version
      run: |
        grep '<version>' pom.xml | head -1 | sed 's/.*<version>//' | sed 's/<\/version>.*//' | xargs -I {} echo "Project version set to: {}"

  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest
    needs: prepare-release

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven

    - name: Build and Test
      run: |
        echo "=== Building Veld Framework ${{ needs.prepare-release.outputs.version }} ==="
        mvn clean install -Dci.skip=true -B
      env:
        MAVEN_OPTS: "-Xmx2g -XX:+UseG1GC"

    - name: Generate Javadoc
      run: |
        echo "=== Generating Javadoc ==="
        mvn javadoc:javadoc -q

    - name: Generate Test Report
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: Test Results
        path: '*/target/surefire-reports/TEST-*.xml'
        reporter: java-junit

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ github.run_number }}
        path: |
          */target/surefire-reports/
          */target/failsafe-reports/
        retention-days: 30

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: prepare-release
    permissions:
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [prepare-release, test-and-build, security-scan]
    if: needs.prepare-release.outputs.is_prerelease == 'false'
    environment: staging

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
        server-id: central
        server-username: SONATYPE_USERNAME
        server-password: SONATYPE_TOKEN

    - name: Set project version for release
      run: |
        VERSION="${{ needs.prepare-release.outputs.version }}"
        echo "Setting project version to: $VERSION"
        mvn versions:set -DnewVersion=$VERSION -DgenerateBackupPoms=false -q

    - name: Install GPG
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y gnupg gnupg2

    - name: Configure GPG
      id: configure-gpg
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        mkdir -p ~/.gnupg
        chmod 700 ~/.gnupg

        echo "use-agent" > ~/.gnupg/gpg.conf
        echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf

        echo "allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf
        chmod 600 ~/.gnupg/gpg.conf
        chmod 600 ~/.gnupg/gpg-agent.conf

        echo "$GPG_PRIVATE_KEY" | base64 -d > private.key
        gpg --batch --import private.key
        rm -f private.key

        KEY_ID=$(gpg --list-secret-keys --keyid-format LONG 2>/dev/null | grep sec | awk '{print $2}' | cut -d'/' -f2 | head -1)
        echo "key_id=$KEY_ID" >> $GITHUB_OUTPUT
        echo "Using GPG Key ID: $KEY_ID"

        gpg --list-secret-keys --keyid-format LONG

    - name: Deploy to Sonatype Nexus (Staging)
      env:
        MAVEN_OPTS: "-Xmx2g -XX:+UseG1GC"
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        GPG_KEYNAME: ${{ steps.configure-gpg.outputs.key_id }}
      run: |
        echo "=== Deploying Veld ${{ needs.prepare-release.outputs.version }} to Staging ==="
        echo "Using GPG key ID: $GPG_KEYNAME"

        mvn clean deploy -B \
          -DskipTests=true \
          -Prelease \
          -Dgpg.passphrase="$GPG_PASSPHRASE" \
          -Dgpg.keyname="$GPG_KEYNAME" \
          -Dgpg.executable=gpg \
          -Dgpg.useAgent=false

    - name: Create Staging Repository Summary
      run: |
        echo "## Staging Deployment Completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ needs.prepare-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** Staging" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. **Manual Verification Required** - Login to Central Publisher Portal:" >> $GITHUB_STEP_SUMMARY
        echo "   - URL: https://central.sonatype.com/" >> $GITHUB_STEP_SUMMARY
        echo "   - Go to 'Deployment' section" >> $GITHUB_STEP_SUMMARY
        echo "   - Find and close the staging repository" >> $GITHUB_STEP_SUMMARY
        echo "2. **Release to Maven Central** - Once verified:" >> $GITHUB_STEP_SUMMARY
        echo "   - Click 'Release' to publish to Maven Central" >> $GITHUB_STEP_SUMMARY
        echo "   - Wait 2-24 hours for synchronization" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f "pom.xml" ]; then
          echo "### Detected Modules from Parent POM" >> $GITHUB_STEP_SUMMARY
          grep '<module>' pom.xml | sed 's/.*<module>//' | sed 's/<\/module>.*//' | while read module; do
            echo "- **$module**: \`io.github.yasmramos:$module:${{ needs.prepare-release.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          done
        fi

    - name: Upload Deployment Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: staging-artifacts-${{ github.run_number }}
        path: |
          **/target/*.jar
          **/target/*.pom
          **/target/*.asc
          **/target/*.md5
          **/target/*.sha1
        retention-days: 30

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [prepare-release, deploy-staging]
    if: always() && needs.deploy-staging.result == 'success'

    steps:
    - name: Create Success Summary
      run: |
        echo "## Release ${{ needs.prepare-release.outputs.version }} Deployed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Veld Framework ${{ needs.prepare-release.outputs.version }} has been deployed to Sonatype Nexus staging repository" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Manual Verification Required" >> $GITHUB_STEP_SUMMARY
        echo "1. **Login to Central Publisher Portal:** https://central.sonatype.com/" >> $GITHUB_STEP_SUMMARY
        echo "2. **Navigate to 'Deployment' section" >> $GITHUB_STEP_SUMMARY
        echo "3. **Find the staging repository for Veld" >> $GITHUB_STEP_SUMMARY
        echo "4. **Click 'Close'** to validate the artifacts" >> $GITHUB_STEP_SUMMARY
        echo "5. **Click 'Release'** to publish to Maven Central" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Maven Central Sync Timeline" >> $GITHUB_STEP_SUMMARY
        echo "After release, it typically takes 2-24 hours for artifacts to appear on Maven Central" >> $GITHUB_STEP_SUMMARY

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [prepare-release, deploy-staging]
    if: always() && needs.deploy-staging.result == 'failure'

    steps:
    - name: Create Failure Summary
      run: |
        echo "## Release Deployment Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The deployment of Veld ${{ needs.prepare-release.outputs.version }} to Sonatype Nexus failed." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Common Issues" >> $GITHUB_STEP_SUMMARY
        echo "- GPG Key Issues: Verify GPG private key is correctly configured" >> $GITHUB_STEP_SUMMARY
        echo "- Sonatype Credentials: Verify SONATYPE_USERNAME and SONATYPE_TOKEN" >> $GITHUB_STEP_SUMMARY
        echo "- Test Failures: Check the test results in the artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Review the deployment logs above" >> $GITHUB_STEP_SUMMARY
        echo "2. Fix the identified issues" >> $GITHUB_STEP_SUMMARY
        echo "3. Retry the deployment workflow" >> $GITHUB_STEP_SUMMARY
