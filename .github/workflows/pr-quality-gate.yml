name: PR Quality Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_target:

jobs:
  pr-quality-check:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup GitHub CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y gh

    - name: Validate Branch Name
      run: |
        echo "Validating branch name..."
        
        BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
        echo "Branch name: $BRANCH_NAME"
        
        # Validar formato b√°sico
        if [[ "$BRANCH_NAME" =~ ^(feature|bugfix|hotfix|refactor|docs|test|chore|style|perf|release)/ ]]; then
          echo "‚úÖ Branch name follows conventions"
          echo "branch_valid=true" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Branch name does not follow conventions"
          echo "branch_valid=false" >> $GITHUB_OUTPUT
          
          # Agregar comentario con sugerencias
          gh pr comment ${{ github.event.pull_request.number }} --body "
          ‚ö†Ô∏è **Branch Name Convention Issue**
          
          The branch name \`$BRANCH_NAME\` does not follow the project's naming conventions.
          
          **Required format:** \`<type>/<description>\`
          
          **Valid types:** feature, bugfix, hotfix, refactor, docs, test, chore, style, perf, release
          
          **Examples:**
          - \`feature/dependency-injection-container\`
          - \`bugfix/npe-in-scanner-logic\`
          - \`docs/api-documentation-update\`
          
          **To fix this:**
          1. Rename your branch: \`git branch -m $BRANCH_NAME new-branch-name\`
          2. Or create a new branch with correct naming
          
          See documentation: [BRANCH_NAMING_CONVENTIONS.md](docs/BRANCH_NAMING_CONVENTIONS.md)
          "
          
          # No fallar el workflow por nombre de rama, solo advertencia
          echo "Adding branch naming guidance to PR"
        fi

    - name: Analyze PR Size
      id: analysis
      run: |
        echo "Analyzing PR..."
        
        # Obtener informaci√≥n b√°sica del PR
        PR_NUMBER=${{ github.event.pull_request.number }}
        echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        
        # Obtener archivos modificados usando GitHub API
        FILES_CHANGED=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/files --jq 'length')
        echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
        
        # Obtener l√≠neas agregadas/removidas
        DIFF_STATS=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER --jq '.additions,.deletions')
        LINES_ADDED=$(echo "$DIFF_STATS" | head -1)
        LINES_REMOVED=$(echo "$DIFF_STATS" | tail -1)
        
        echo "lines_added=$LINES_ADDED" >> $GITHUB_OUTPUT
        echo "lines_removed=$LINES_REMOVED" >> $GITHUB_OUTPUT
        
        # Calcular tama√±o total del PR
        TOTAL_LINES=$((LINES_ADDED + LINES_REMOVED))
        echo "total_lines=$TOTAL_LINES" >> $GITHUB_OUTPUT
        
        # Determinar tama√±o del PR
        if [ "$TOTAL_LINES" -gt "400" ]; then
          PR_SIZE="large"
        elif [ "$TOTAL_LINES" -gt "100" ]; then
          PR_SIZE="medium"
        else
          PR_SIZE="small"
        fi
        echo "pr_size=$PR_SIZE" >> $GITHUB_OUTPUT
        
        echo "PR Analysis Complete:"
        echo "  Files changed: $FILES_CHANGED"
        echo "  Lines added: $LINES_ADDED"
        echo "  Lines removed: $LINES_REMOVED"
        echo "  Total lines: $TOTAL_LINES"
        echo "  PR Size: $PR_SIZE"

    - name: Check Required Labels
      run: |
        echo "Checking required labels..."
        
        # Obtener etiquetas del PR
        LABELS=$(gh pr view ${{ github.event.pull_request.number }} --json labels --jq '.labels[].name' 2>/dev/null || echo "")
        echo "Current labels: $LABELS"
        
        # Verificar etiquetas de tipo
        TYPE_LABELS=("feature" "bugfix" "hotfix" "refactor" "documentation" "test" "build")
        HAS_TYPE=false
        for label in "${TYPE_LABELS[@]}"; do
          if echo "$LABELS" | grep -q "$label"; then
            HAS_TYPE=true
            echo "‚úÖ Found type label: $label"
            break
          fi
        done
        
        if [ "$HAS_TYPE" = false ]; then
          echo "‚ùå Missing required type label"
          echo "::error::PR must have at least one type label: feature, bugfix, hotfix, refactor, documentation, test, build"
          exit 1
        fi
        
        # Verificar etiquetas de prioridad
        PRIORITY_LABELS=("priority:high" "priority:medium" "priority:low")
        HAS_PRIORITY=false
        for label in "${PRIORITY_LABELS[@]}"; do
          if echo "$LABELS" | grep -q "$label"; then
            HAS_PRIORITY=true
            echo "‚úÖ Found priority label: $label"
            break
          fi
        done
        
        if [ "$HAS_PRIORITY" = false ]; then
          echo "‚ùå Missing required priority label"
          echo "::error::PR must have at least one priority label: priority:high, priority:medium, priority:low"
          exit 1
        fi
        
        echo "‚úÖ All required labels present"

    - name: Auto-assign Reviewers
      run: |
        PR_SIZE=${{ steps.analysis.outputs.pr_size }}
        PR_NUMBER=${{ steps.analysis.outputs.pr_number }}
        
        echo "Assigning reviewers for PR size: $PR_SIZE"
        
        # Lista de reviewers disponibles
        REVIEWERS=("YasMRamos")
        
        # Asignar reviewers basado en tama√±o
        if [ "$PR_SIZE" = "large" ]; then
          # Para PRs grandes, asignar m√∫ltiples reviewers si es posible
          gh pr edit $PR_NUMBER --add-reviewers "${REVIEWERS[0]}" 2>/dev/null || echo "Could not assign reviewers"
          echo "‚úÖ Assigned primary reviewer for large PR"
        elif [ "$PR_SIZE" = "medium" ]; then
          # Para PRs medianos, asignar al menos un reviewer
          gh pr edit $PR_NUMBER --add-reviewers "${REVIEWERS[0]}" 2>/dev/null || echo "Could not assign reviewers"
          echo "‚úÖ Assigned reviewer for medium PR"
        else
          # Para PRs peque√±os, asignar reviewer opcional
          echo "‚ÑπÔ∏è Small PR - manual reviewer assignment recommended"
        fi

    - name: Add Quality Gate Comment
      run: |
        PR_NUMBER=${{ steps.analysis.outputs.pr_number }}
        PR_SIZE=${{ steps.analysis.outputs.pr_size }}
        FILES_CHANGED=${{ steps.analysis.outputs.files_changed }}
        TOTAL_LINES=${{ steps.analysis.outputs.total_lines }}
        
        COMMENT="## üõ°Ô∏è PR Quality Gate Analysis
        
### üìä PR Summary
- **Size**: $PR_SIZE ($FILES_CHANGED files changed, $TOTAL_LINES lines total)
- **Quality Checks**: ‚úÖ Passed
- **Labels**: ‚úÖ Verified
- **Reviewers**: üë• Assigned
        
### ‚úÖ Checklist
- [x] PR follows naming conventions
- [x] Required labels present
- [x] Appropriate reviewers assigned
- [x] Ready for review
        
### üéØ Next Steps
1. Await reviewer approval
2. Address any feedback
3. Ensure all CI checks pass
4. Merge when approved
        
---
*Generated by PR Quality Gate*"
        
        gh pr comment $PR_NUMBER --body "$COMMENT" 2>/dev/null || echo "Could not add comment"

    - name: Check Large PR Reviewers
      if: steps.analysis.outputs.pr_size == 'large'
      run: |
        PR_NUMBER=${{ steps.analysis.outputs.pr_number }}
        TOTAL_LINES=${{ steps.analysis.outputs.total_lines }}
        
        echo "Checking reviewers for large PR..."
        
        # Verificar n√∫mero de reviewers
        REVIEWERS=$(gh pr view $PR_NUMBER --json reviewRequests --jq '.reviewRequests | length' 2>/dev/null || echo "0")
        echo "Current reviewers: $REVIEWERS"
        
        if [ "$REVIEWERS" -lt "2" ]; then
          echo "‚ùå Large PR requires at least 2 reviewers"
          echo "::error::Large PRs (>$TOTAL_LINES lines) require minimum 2 reviewers for security and quality"
          
          # Agregar comentario explicativo
          gh pr comment $PR_NUMBER --body "
          ‚ö†Ô∏è **Large PR Detected**
          
          This PR has over 400 lines of changes and requires **minimum 2 reviewers** for security and quality assurance.
          
          Current reviewers: $REVIEWERS
          Required reviewers: 2
          
          Please add additional reviewers before proceeding with the review.
          " 2>/dev/null || echo "Could not add large PR comment"
          
          exit 1
        fi

    - name: Quality Gate Summary
      run: |
        echo "## üõ°Ô∏è PR Quality Gate Complete"
        echo ""
        echo "**Status**: SUCCESS"
        echo ""
        echo "**Checks Performed**:"
        echo "- ‚úÖ Required labels verification"
        echo "- ‚úÖ Automatic reviewer assignment"
        echo "- ‚úÖ Size-based enforcement"
        echo "- ‚úÖ Quality gate comment added"
        echo ""
        echo "üéâ **All quality checks passed!**"
        echo "PR is ready for review and merge."