# Veld CI/CD Pipeline
# Automated build, test, and release pipeline for Maven Central

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Dmaven.wagon.http.pool=false -Dmaven.wagon.httpconnectionManager.ttlSeconds=120'

jobs:
  # Matrix build for different Java versions
  test:
    name: Test (Java ${{ matrix.java-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: [ '11', '17', '21' ]
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for release plugin
    
    - name: Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
        cache: 'maven'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Validate Maven configuration
      run: mvn validate
    
    - name: Run tests
      run: mvn test -B
    
    - name: Generate test report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Test Results (Java ${{ matrix.java-version }})
        path: '*/target/surefire-reports/*.xml'
        fail-on-error: 'false'
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.java-version }}
        path: '**/target/surefire-reports/'
        retention-days: 7
    
    - name: Generate coverage report
      run: mvn jacoco:report-aggregate
      if: matrix.java-version == '17'
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: matrix.java-version == '17'
      with:
        file: '**/target/site/jacoco-aggregate/jacoco.xml'
        fail_ci_if_error: false
    
    - name: Quality Gate Check
      run: |
        COVERAGE=$(grep -o 'COVEREDRATIO>[0-9.]*' target/site/jacoco-aggregate/jacoco.xml | cut -d'>' -f2 | head -1)
        echo "Test coverage: $COVERAGE"
        if (( $(echo "$COVERAGE < 0.10" | bc -l) )); then
          echo "âŒ Test coverage too low: $COVERAGE (minimum 10%)"
          exit 1
        fi
      if: matrix.java-version == '17'

  # Security and quality checks
  quality:
    name: Quality & Security
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
    
    - name: Run SonarQube Analysis
      uses: SonarSource/sonarqube-scan-action@master
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      with:
        projectBaseDir: .
        args: >
          -Dsonar.projectKey=veld-framework
          -Dsonar.projectName=Veld Framework
          -Dsonar.sources=.
          -Dsonar.tests=.
          -Dsonar.java.coveragePlugin=jacoco
          -Dsonar.jacoco.reportPath=target/site/jacoco-aggregate/jacoco.xml
    
    - name: OWASP Dependency Check
      run: |
        mvn dependency-check:check -DfailOnCVSS=7
    
    - name: Upload OWASP Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: owasp-report
        path: '**/dependency-check-report.html'

  # Build artifacts
  build:
    name: Build Artifacts
    needs: [test, quality]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
    
    - name: Build with Maven
      run: mvn clean compile -DskipTests
    
    - name: Generate Javadoc
      run: mvn javadoc:javadoc
    
    - name: Upload Javadoc Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: javadoc
        path: '**/target/site/apidocs/'
    
    - name: Generate Assembly
      run: |
        mvn source:jar
        mvn javadoc:jar
        mvn assembly:single -DdescriptorId=project
    
    - name: Upload Distribution Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: distribution
        path: '**/target/*-sources.jar'
        path: '**/target/*-javadoc.jar'
        path: '**/target/*.zip'
        path: '**/target/*.tar.gz'

  # Deploy to GitHub Packages (on every push to main)
  deploy-github:
    name: Deploy to GitHub Packages
    needs: [test, quality, build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
    
    - name: Setup Maven settings
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Configure GitHub Packages
      run: |
        mkdir -p ~/.m2
        cat > ~/.m2/settings.xml << EOF
        <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0">
          <servers>
            <server>
              <id>github</id>
              <username>github-actions[bot]</username>
              <password>${{ secrets.GITHUB_TOKEN }}</password>
            </server>
          </servers>
        </settings>
        EOF
    
    - name: Deploy to GitHub Packages
      run: mvn clean deploy -DskipTests=true -DskipGpg=true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Deploy to Maven Central (on release)
  deploy-maven-central:
    name: Deploy to Maven Central
    needs: [test, quality, build]
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.action == 'published'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
    
    - name: Import GPG key
      uses: crazy-max/ghaction-import-gpg@v6
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.GPG_PASSPHRASE }}
        git_user_signing_key: true
    
    - name: Configure Maven for Maven Central
      run: |
        mkdir -p ~/.m2
        cat > ~/.m2/settings.xml << EOF
        <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0">
          <servers>
            <server>
              <id>ossrh</id>
              <username>${{ secrets.OSSRH_USERNAME }}</username>
              <password>${{ secrets.OSSRH_PASSWORD }}</password>
            </server>
            <server>
              <id>gpg.passphrase</id>
              <passphrase>${{ secrets.GPG_PASSPHRASE }}</passphrase>
            </server>
            <server>
              <id>gpg.keyname</id>
              <keyname>${{ secrets.GPG_KEYNAME }}</keyname>
            </server>
          </servers>
        </settings>
        EOF
    
    - name: Deploy to Maven Central
      run: mvn clean deploy -DskipTests=false
      env:
        OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
        OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
        GPG_KEYNAME: ${{ secrets.GPG_KEYNAME }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
    
    - name: Close and Release Staging Repository
      run: |
        # Wait for staging repository to be available
        sleep 60
        
        # Close staging repository
        curl -X POST -u ${{ secrets.OSSRH_USERNAME }}:${{ secrets.OSSRH_PASSWORD }} \
          "https://s01.oss.sonatype.org/service/local/staging/bulk/close" \
          -H "Content-Type: application/json" \
          -d '{"description":"Veld Framework '${{ github.event.release.tag_name }}' release"}'
        
        # Release staging repository  
        sleep 30
        curl -X POST -u ${{ secrets.OSSRH_USERNAME }}:${{ secrets.OSSRH_PASSWORD }} \
          "https://s01.oss.sonatype.org/service/local/staging/bulk/release" \
          -H "Content-Type: application/json" \
          -d '{"description":"Veld Framework '${{ github.event.release.tag_name }}' release"}'

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    needs: [deploy-maven-central]
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.action == 'published'
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: distribution
    
    - name: Create Release Assets
      run: |
        mkdir -p release-assets
        cp **/*-sources.jar release-assets/
        cp **/*-javadoc.jar release-assets/
        cp **/*.zip release-assets/
        cp **/*.tar.gz release-assets/
        ls -la release-assets/
    
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      with:
        files: release-assets/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Documentation deployment
  deploy-docs:
    name: Deploy Documentation
    needs: [test, quality]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        publish_branch: gh-pages
        force_orphan: true