name: Validate Release Readiness

on:
  push:
    branches: [ main ]
    paths:
      - 'pom.xml'
      - 'veld-*/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'pom.xml'
      - 'veld-*/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  validate-project-structure:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check required files exist
      run: |
        echo "=== Validating Project Structure ==="
        
        required_files=(
          "pom.xml"
          "LICENSE"
          "README.md"
          "CHANGELOG.md"
          "veld-annotations/pom.xml"
          "veld-runtime/pom.xml"
          "veld-processor/pom.xml"
          "veld-weaver/pom.xml"
          "veld-aop/pom.xml"
          "veld-spring-boot-starter/pom.xml"
          "veld-maven-plugin/pom.xml"
          "veld-benchmark/pom.xml"
          "veld-example/pom.xml"
        )
        
        missing_files=()
        for file in "${required_files[@]}"; do
          if [[ ! -f "$file" ]]; then
            missing_files+=("$file")
          fi
        done
        
        if [[ ${#missing_files[@]} -gt 0 ]]; then
          echo "âŒ Missing required files:"
          printf '%s\n' "${missing_files[@]}"
          exit 1
        else
          echo "âœ… All required files present"
        fi
        
    - name: Validate Maven POM files
      run: |
        echo "=== Validating Maven POM Files ==="
        
        # Check parent POM
        if ! mvn validate -f pom.xml; then
          echo "âŒ Parent POM validation failed"
          exit 1
        fi
        
        # Check all module POMs
        find . -name "pom.xml" -not -path "./.mvn/*" | while read pom; do
          echo "Validating $pom"
          if ! mvn validate -f "$pom" -q; then
            echo "âŒ POM validation failed for $pom"
            exit 1
          fi
        done
        
        echo "âœ… All POM files are valid"
        
    - name: Check for SNAPSHOT dependencies
      run: |
        echo "=== Checking for SNAPSHOT Dependencies ==="
        
        snapshot_deps=$(find . -name "pom.xml" -exec grep -l "SNAPSHOT" {} \; | wc -l)
        
        if [[ $snapshot_deps -gt 0 ]]; then
          echo "âŒ Found SNAPSHOT dependencies in $snapshot_deps POM files:"
          find . -name "pom.xml" -exec grep -l "SNAPSHOT" {} \;
          exit 1
        else
          echo "âœ… No SNAPSHOT dependencies found"
        fi

  validate-compilation:
    name: Validate Compilation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
        
    - name: Clean and compile
      run: |
        echo "=== Compiling Veld Framework ==="
        mvn clean compile -q
        
    - name: Verify compilation artifacts
      run: |
        echo "=== Verifying Compilation Artifacts ==="
        
        expected_artifacts=(
          "veld-annotations/target/veld-annotations-*.jar"
          "veld-runtime/target/veld-runtime-*.jar"
          "veld-processor/target/veld-processor-*.jar"
          "veld-weaver/target/veld-weaver-*.jar"
        )
        
        missing_artifacts=()
        for pattern in "${expected_artifacts[@]}"; do
          if ! ls $pattern 1> /dev/null 2>&1; then
            missing_artifacts+=("$pattern")
          fi
        done
        
        if [[ ${#missing_artifacts[@]} -gt 0 ]]; then
          echo "âŒ Missing compilation artifacts:"
          printf '%s\n' "${missing_artifacts[@]}"
          exit 1
        else
          echo "âœ… All expected artifacts compiled successfully"
        fi

  validate-tests:
    name: Validate Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
        
    - name: Run unit tests
      run: |
        echo "=== Running Unit Tests ==="
        mvn test -q
        
    - name: Run integration tests
      run: |
        echo "=== Running Integration Tests ==="
        mvn integration-test -q
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ github.run_number }}
        path: |
          */target/surefire-reports/
          */target/failsafe-reports/
        retention-days: 7

  validate-documentation:
    name: Validate Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
        
    - name: Generate Javadoc
      run: |
        echo "=== Generating Javadoc ==="
        mvn javadoc:javadoc -q
        
    - name: Check Javadoc completeness
      run: |
        echo "=== Checking Javadoc Completeness ==="
        
        # Check if Javadoc was generated for core modules
        javadoc_dirs=(
          "veld-annotations/target/site/apidocs"
          "veld-runtime/target/site/apidocs"
          "veld-processor/target/site/apidocs"
        )
        
        missing_javadoc=()
        for dir in "${javadoc_dirs[@]}"; do
          if [[ ! -d "$dir" ]]; then
            missing_javadoc+=("$dir")
          fi
        done
        
        if [[ ${#missing_javadoc[@]} -gt 0 ]]; then
          echo "âŒ Missing Javadoc directories:"
          printf '%s\n' "${missing_javadoc[@]}"
          exit 1
        else
          echo "âœ… Javadoc generated successfully"
        fi
        
    - name: Validate README content
      run: |
        echo "=== Validating README Content ==="
        
        # Check if README contains essential sections
        required_sections=(
          "Usage"
          "Dependencies"
          "Maven"
          "Gradle"
          "Example"
        )
        
        missing_sections=()
        for section in "${required_sections[@]}"; do
          if ! grep -qi "$section" README.md; then
            missing_sections+=("$section")
          fi
        done
        
        if [[ ${#missing_sections[@]} -gt 0 ]]; then
          echo "âŒ Missing README sections:"
          printf '%s\n' "${missing_sections[@]}"
          exit 1
        else
          echo "âœ… README contains all required sections"
        fi

  validate-benchmarks:
    name: Validate Benchmarks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
        
    - name: Build benchmark module
      run: |
        echo "=== Building Benchmark Module ==="
        mvn clean package -pl veld-benchmark -am -DskipTests -q
        
    - name: Verify benchmark JAR
      run: |
        echo "=== Verifying Benchmark JAR ==="
        
        if [[ -f "veld-benchmark/target/veld-benchmark.jar" ]]; then
          echo "âœ… Benchmark JAR created successfully"
          ls -la veld-benchmark/target/veld-benchmark.jar
          
          # Quick test to ensure JAR is executable
          if java -jar veld-benchmark/target/veld-benchmark.jar --help 2>/dev/null || echo "JAR test completed"; then
            echo "âœ… Benchmark JAR is executable"
          fi
        else
          echo "âŒ Benchmark JAR not found"
          exit 1
        fi



  create-validation-report:
    name: Create Validation Report
    runs-on: ubuntu-latest
    needs: [
      validate-project-structure,
      validate-compilation,
      validate-tests,
      validate-documentation,
      validate-benchmarks
    ]
    if: always()
    
    steps:
    - name: Create Validation Summary
      run: |
        echo "## ðŸ“‹ Release Validation Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Validation Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### âœ… Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Project Structure
        if [[ "${{ needs.validate-project-structure.result }}" == "success" ]]; then
          echo "âœ… **Project Structure** - All required files present" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Project Structure** - Issues detected" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Compilation
        if [[ "${{ needs.validate-compilation.result }}" == "success" ]]; then
          echo "âœ… **Compilation** - All modules compile successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Compilation** - Build failures detected" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Tests
        if [[ "${{ needs.validate-tests.result }}" == "success" ]]; then
          echo "âœ… **Tests** - All tests passing" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Tests** - Test failures detected" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Documentation
        if [[ "${{ needs.validate-documentation.result }}" == "success" ]]; then
          echo "âœ… **Documentation** - Javadoc and README validated" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Documentation** - Documentation issues detected" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Benchmarks
        if [[ "${{ needs.validate-benchmarks.result }}" == "success" ]]; then
          echo "âœ… **Benchmarks** - Benchmark module builds successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Benchmarks** - Benchmark build failures" >> $GITHUB_STEP_SUMMARY
        fi
        

        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Overall status
        failed_jobs=0
        total_jobs=5
        
        [[ "${{ needs.validate-project-structure.result }}" != "success" ]] && ((failed_jobs++))
        [[ "${{ needs.validate-compilation.result }}" != "success" ]] && ((failed_jobs++))
        [[ "${{ needs.validate-tests.result }}" != "success" ]] && ((failed_jobs++))
        [[ "${{ needs.validate-documentation.result }}" != "success" ]] && ((failed_jobs++))
        [[ "${{ needs.validate-benchmarks.result }}" != "success" ]] && ((failed_jobs++))

        
        if [[ $failed_jobs -eq 0 ]]; then
          echo "## ðŸŽ‰ **READY FOR RELEASE**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All validation checks passed! The project is ready for deployment to Maven Central." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Create a release tag (e.g., v1.0.0)" >> $GITHUB_STEP_SUMMARY
          echo "2. The release workflow will automatically deploy to Sonatype Nexus" >> $GITHUB_STEP_SUMMARY
          echo "3. Close and release the staging repository" >> $GITHUB_STEP_SUMMARY
          echo "4. Wait for Maven Central synchronization" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âš ï¸ **RELEASE BLOCKED**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$failed_jobs out of $total_jobs validation checks failed. Please fix the issues before proceeding with the release." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Common Solutions" >> $GITHUB_STEP_SUMMARY
          echo "- Fix compilation errors in the failing modules" >> $GITHUB_STEP_SUMMARY
          echo "- Resolve test failures" >> $GITHUB_STEP_SUMMARY
          echo "- Complete missing documentation" >> $GITHUB_STEP_SUMMARY
          echo "- Ensure all required files are present" >> $GITHUB_STEP_SUMMARY
        fi