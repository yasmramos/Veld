name: Examples Simple Build

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'veld-example/**'
      - 'veld-annotations/**'
      - 'veld-runtime/**'
      - 'veld-processor/**'
      - 'veld-weaver/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'veld-example/**'
      - 'veld-annotations/**'
      - 'veld-runtime/**'
      - 'veld-processor/**'
      - 'veld-weaver/**'
  workflow_dispatch:

jobs:
  build-core-modules:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Build Veld Annotations (with retries)
      run: |
        cd $GITHUB_WORKSPACE
        # Try to build with network retry logic
        for i in {1..3}; do
          echo "Attempt $i: Building veld-annotations..."
          if mvn clean install -pl veld-annotations -Dmaven.test.skip=true -Dmaven.source.skip=true -Ddepgraph.skip=true -Djacoco.skip=true -B -q; then
            echo "âœ… veld-annotations built successfully"
            break
          else
            echo "âŒ Attempt $i failed, retrying..."
            sleep 10
          fi
        done
        
    - name: Build Veld Runtime (with dependencies)
      run: |
        cd $GITHUB_WORKSPACE
        echo "Building veld-runtime with dependencies..."
        mvn clean install -pl veld-runtime -am -Dmaven.test.skip=true -Dmaven.source.skip=true -Ddepgraph.skip=true -Djacoco.skip=true -B -q
        
    - name: Build Veld AOP Module
      run: |
        cd $GITHUB_WORKSPACE
        echo "Building veld-aop with dependencies..."
        mvn clean install -pl veld-aop -am -Dmaven.test.skip=true -Dmaven.source.skip=true -Ddepgraph.skip=true -Djacoco.skip=true -B -q
        
    - name: Build Veld Processor Module
      run: |
        cd $GITHUB_WORKSPACE
        echo "Building veld-processor with dependencies..."
        mvn clean install -pl veld-processor -am -Dmaven.test.skip=true -Dmaven.source.skip=true -Ddepgraph.skip=true -Djacoco.skip=true -B -q
        
    - name: Build Veld Weaver Module
      run: |
        cd $GITHUB_WORKSPACE
        echo "Building veld-weaver with dependencies..."
        mvn clean install -pl veld-weaver -am -Dmaven.test.skip=true -Dmaven.source.skip=true -Ddepgraph.skip=true -Djacoco.skip=true -B -q
        
    - name: Build Veld Maven Plugin
      run: |
        cd $GITHUB_WORKSPACE
        echo "Building veld-maven-plugin with dependencies..."
        mvn clean install -pl veld-maven-plugin -am -Dmaven.test.skip=true -Dmaven.source.skip=true -B -q
        
    - name: Check Plugin Build Success
      run: |
        cd $GITHUB_WORKSPACE
        if [ -f "veld-maven-plugin/target/veld-maven-plugin-1.0.0-SNAPSHOT.jar" ]; then
          echo "âœ… Veld Maven Plugin built successfully"
          ls -la veld-maven-plugin/target/*.jar
        else
          echo "âŒ Veld Maven Plugin build failed"
          echo "Contents of veld-maven-plugin/target:"
          ls -la veld-maven-plugin/target/ 2>/dev/null || echo "Target directory does not exist"
          exit 1
        fi
        
    - name: Build Examples without Veld Plugin
      run: |
        cd $GITHUB_WORKSPACE
        echo "Building examples without Veld plugin (temporarily disabled)..."
        # The POM has been modified to exclude the Veld plugin temporarily
        mvn clean compile -pl veld-example -am -Dmaven.test.skip=true -Dmaven.source.skip=true -Ddepgraph.skip=true -Djacoco.skip=true -B -q
        
    - name: Verify Core Compilation
      run: |
        cd $GITHUB_WORKSPACE
        echo "ðŸ” Verifying compilation results..."
        if [ -d "veld-example/target/classes" ]; then
          echo "âœ… Example compilation successful"
          echo "ðŸ“ Class files found:"
          find veld-example/target/classes -name "*.class" | wc -l
          echo "ðŸ“‹ Sample classes:"
          find veld-example/target/classes -name "*.class" | head -5
        else
          echo "âŒ Example compilation failed"
          exit 1
        fi
        
    - name: Summary
      run: |
        echo "## ðŸ“‹ Simple Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Build Status" >> $GITHUB_STEP_SUMMARY
        echo "- Veld Core Modules: **Built Successfully**" >> $GITHUB_STEP_SUMMARY
        echo "- Veld Maven Plugin: **Built Successfully**" >> $GITHUB_STEP_SUMMARY
        echo "- Examples: **Compiled Successfully**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ Notes" >> $GITHUB_STEP_SUMMARY
        echo "- Veld Maven Plugin temporarily disabled in examples due to circular dependency" >> $GITHUB_STEP_SUMMARY
        echo "- Core functionality compilation verified" >> $GITHUB_STEP_SUMMARY
        echo "- Ready for full plugin integration once connectivity issues resolved" >> $GITHUB_STEP_SUMMARY