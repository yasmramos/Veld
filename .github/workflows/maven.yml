# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

name: Java CI with Maven

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# Fast CI pipeline for main branch and PRs
# For comprehensive checks (security, compliance, artifacts), see advanced-ci-cd.yml

jobs:
  build:
    runs-on: ubuntu-latest
    
    timeout-minutes: 15  # 15 minutos de timeout

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: Display Maven and Java versions
      run: |
        echo "Maven version:"
        mvn -version
        echo "Java version:"
        java -version
        echo "Java home: $JAVA_HOME"
    
    - name: Display project structure
      run: |
        echo "Project structure:"
        find . -name "pom.xml" | head -10
        echo "Java source directories:"
        find . -path "*/src/main/java" -type d | head -10
    
    - name: Clean and compile with detailed output
      run: |
        echo "=== Starting Maven clean compile ==="
        mvn clean compile -X --batch-mode
      env:
        MAVEN_OPTS: "-Xmx2g -XX:+UseG1GC"
      timeout-minutes: 10
    
    - name: Display compilation results
      run: |
        echo "=== Compilation Results ==="
        if [ -d "target/classes" ]; then
          echo "✅ Compilation successful - target/classes exists"
          echo "Compiled classes:"
          find target/classes -name "*.class" | head -20
        else
          echo "❌ Compilation failed - target/classes not found"
          echo "Checking for error logs..."
          find . -name "*.log" -o -name "*.err" 2>/dev/null | head -5
        fi

    - name: Run unit tests
      run: |
        echo "=== Starting Maven test phase ==="
        mvn test --batch-mode
      env:
        MAVEN_OPTS: "-Xmx2g -XX:+UseG1GC"
      timeout-minutes: 10

    - name: Display test results
      run: |
        echo "=== Test Results ==="
        if [ -d "target/surefire-reports" ]; then
          echo "✅ Tests executed - surefire-reports exists"
          echo "Test reports:"
          find target/surefire-reports -name "*.xml" | head -10
          echo ""
          echo "Test summary:"
          find target/surefire-reports -name "TEST-*.xml" -exec grep -h "testsuite" {} \; | head -5
        else
          echo "⚠️ No test reports found"
        fi

    - name: Run integration tests
      run: |
        echo "=== Starting Maven integration test phase ==="
        mvn verify -DskipITs=false -DskipGpg=true --batch-mode
      env:
        MAVEN_OPTS: "-Xmx2g -XX:+UseG1GC"
      timeout-minutes: 10

    - name: Display integration test results
      run: |
        echo "=== Integration Test Results ==="
        if [ -d "target/failsafe-reports" ]; then
          echo "✅ Integration tests executed - failsafe-reports exists"
          echo "Integration test reports:"
          find target/failsafe-reports -name "*.xml" | head -10
        else
          echo "⚠️ No integration test reports found (this is OK if no ITs exist)"
        fi
    
    - name: Show Maven output logs
      if: failure()
      run: |
        echo "=== Maven Debug Output ==="
        echo "Looking for Maven logs..."
        ls -la ~/.m2/repository/ 2>/dev/null || echo "No Maven repository found"
        
        echo "=== System Information ==="
        df -h
        free -h
        ulimit -a
