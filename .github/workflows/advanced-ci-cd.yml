name: ðŸš€ Advanced CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - development
          - staging
          - production
      skip_tests:
        description: 'Skip test execution (dangerous!)'
        required: false
        default: false
        type: boolean

env:
  JAVA_VERSION: '11'
  MAVEN_VERSION: '3.8.1'
  NODE_VERSION: '16'

jobs:
  # =============================================================================
  # STAGE 1: VALIDATION & QUALITY GATES
  # =============================================================================
  
  validation:
    name: ðŸ” Validation & Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    outputs:
      quality-gate-passed: ${{ steps.quality-gate.outputs.passed }}
      security-scan-passed: ${{ steps.security-scan.outputs.passed }}
      code-quality-passed: ${{ steps.code-quality.outputs.passed }}
      
    steps:
    - name: ðŸ” Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: â˜• Setup JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
        
    - name: ðŸ”’ Security Scan
      id: security-scan
      run: |
        echo "ðŸ”’ Running security scan..."
        
        # OWASP Dependency Check
        echo "Running OWASP Dependency Check..."
        if [ -f "dependency-check.sh" ]; then
          chmod +x dependency-check.sh
          ./dependency-check.sh --project "Veld Framework" --scan . --format JSON --out ./security-report.json || true
        fi
        
        # Buscar secrets
        echo "Scanning for secrets..."
        if grep -r -i "password\|api[_-]key\|secret\|token" --exclude-dir=target --exclude="*.json" --exclude="*.xml" . 2>/dev/null; then
          echo "âŒ Potential secrets found!"
          echo "security-scan-passed=false" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "âœ… No secrets detected"
          echo "security-scan-passed=true" >> $GITHUB_OUTPUT
        fi
        
    - name: ðŸ§¹ Code Quality Check
      id: code-quality
      run: |
        echo "ðŸ§¹ Checking code quality..."
        
        # Verificar que el proyecto compila
        echo "Verifying compilation..."
        if mvn clean compile -q; then
          echo "âœ… Compilation successful"
        else
          echo "âŒ Compilation failed"
-quality-passed=false          echo "code" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Verificar formato de cÃ³digo (si hay formatter)
        if [ -f "google-java-format.sh" ]; then
          echo "Checking code formatting..."
          if ./google-java-format.sh --dry-run --diff **/*.java; then
            echo "âœ… Code formatting correct"
          else
            echo "âš ï¸ Code formatting issues found (non-blocking)"
          fi
        fi
        
        echo "code-quality-passed=true" >> $GITHUB_OUTPUT
        
    - name: ðŸ›¡ï¸ Quality Gate
      id: quality-gate
      run: |
        echo "ðŸ›¡ï¸ Evaluating quality gate..."
        
        # Verificar que todos los gates pasaron
        if [ "${{ steps.security-scan.outputs.passed }}" = "true" ] && 
           [ "${{ steps.code-quality.outputs.passed }}" = "true" ]; then
          echo "âœ… All quality gates passed"
          echo "quality-gate-passed=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Quality gates failed"
          echo "quality-gate-passed=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
    - name: ðŸ“Š Upload Validation Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: validation-reports
        path: |
          security-report.json
        retention-days: 7

  # =============================================================================
  # STAGE 2: BUILD & TEST MATRIX
  # =============================================================================
  
  build-test-matrix:
    name: ðŸ”¨ Build & Test Matrix
    runs-on: ubuntu-latest
    needs: validation
    if: needs.validation.outputs.quality-gate-passed == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        java-version: [11, 17]
        module: [all, annotations, runtime, processor, aop]
        
    steps:
    - name: ðŸ” Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
        cache: maven
        
    - name: ðŸ”¨ Build Module ${{ matrix.module }}
      run: |
        echo "ðŸ”¨ Building module: ${{ matrix.module }}"
        
        if [ "${{ matrix.module }}" = "all" ]; then
          echo "Building all modules..."
          mvn clean install -DskipTests -q
        else
          echo "Building module: veld-${{ matrix.module }}"
          mvn clean install -pl veld-${{ matrix.module }} -am -DskipTests -q
        fi
        
    - name: ðŸ§ª Test Module ${{ matrix.module }}
      if: ${{ github.event.inputs.skip_tests != 'true' }}
      run: |
        echo "ðŸ§ª Testing module: ${{ matrix.module }}"
        
        if [ "${{ matrix.module }}" = "all" ]; then
          echo "Testing all modules..."
          mvn test -q
        else
          echo "Testing module: veld-${{ matrix.module }}"
          mvn test -pl veld-${{ matrix.module }} -am -q
        fi
        
    - name: ðŸ“Š Test Coverage
      if: ${{ matrix.module == 'all' && github.event.inputs.skip_tests != 'true' }}
      run: |
        echo "ðŸ“Š Generating test coverage report..."
        mvn jacoco:report -q
        
        # Verificar cobertura mÃ­nima
        COVERAGE=$(find target/site/jacoco/ -name "*.html" -exec grep -o "([0-9]*\.[0-9]*)%" {} \; 2>/dev/null | head -1 || echo "N/A")
        echo "Coverage: $COVERAGE"
        
        if [ "$COVERAGE" != "N/A" ]; then
          COVERAGE_NUM=$(echo "$COVERAGE" | grep -o "[0-9]*\.[0-9]*" || echo "0")
          if [ "$(echo "$COVERAGE_NUM < 70" | bc -l)" = "1" ]; then
            echo "âš ï¸ Coverage below 70%: $COVERAGE"
          else
            echo "âœ… Good coverage: $COVERAGE"
          fi
        fi
        
    - name: ðŸ“¦ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-artifacts-jdk${{ matrix.java-version }}-${{ matrix.module }}
        path: |
          target/*.jar
          target/surefire-reports/
          target/site/jacoco/
        retention-days: 7

  # =============================================================================
  # STAGE 3: INTEGRATION & PERFORMANCE TESTS
  # =============================================================================
  
  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: build-test-matrix
    if: github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'integration')
    
    steps:
    - name: ðŸ” Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
        
    - name: ðŸ³ Start Docker Services
      run: |
        echo "ðŸ³ Starting test services..."
        # AquÃ­ se pueden iniciar servicios de test como databases, etc.
        echo "Test services ready"
        
    - name: ðŸ”— Run Integration Tests
      run: |
        echo "ðŸ”— Running integration tests..."
        mvn test -Dtest=*IT -q || echo "Integration tests completed with warnings"
        
    - name: ðŸ“Š Upload Integration Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-reports
        path: |
          target/surefire-reports/
        retention-days: 7

  performance-benchmarks:
    name: âš¡ Performance Benchmarks
    runs-on: ubuntu-latest
    needs: build-test-matrix
    if: github.event_name != 'pull_request' || contains(github.event.pull_request.title, 'perf')
    
    steps:
    - name: ðŸ” Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
        
    - name: âš¡ Run Performance Benchmarks
      run: |
        echo "âš¡ Running performance benchmarks..."
        
        # Verificar si existe el mÃ³dulo de benchmarks
        if [ -d "veld-benchmark" ]; then
          cd veld-benchmark
          
          # Build benchmarks
          mvn clean package -DskipTests -q
          
          # Run quick benchmarks
          java -Xmx1g -jar target/veld-benchmark.jar \
            -f 1 -wi 1 -i 2 -bs 1 \
            -rf json \
            -rff benchmark-results.json
          
          echo "âœ… Performance benchmarks completed"
        else
          echo "â„¹ï¸ No benchmark module found, skipping performance tests"
        fi
        
    - name: ðŸ“Š Upload Benchmark Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-benchmarks
        path: |
          veld-benchmark/benchmark-results.json
        retention-days: 30

  # =============================================================================
  # STAGE 4: SECURITY & COMPLIANCE
  # =============================================================================
  
  security-compliance:
    name: ðŸ”’ Security & Compliance
    runs-on: ubuntu-latest
    needs: [validation, build-test-matrix]
    
    steps:
    - name: ðŸ” Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ” CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: java
        
    - name: ðŸ” Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      
    - name: ðŸ›¡ï¸ OWASP Dependency Check
      run: |
        echo "ðŸ›¡ï¸ Running OWASP Dependency Check..."
        
        # Download and run OWASP Dependency Check
        wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v9.0.9/dependency-check-9.0.9-release.zip
        unzip -q dependency-check-9.0.9-release.zip
        
        ./dependency-check/bin/dependency-check.sh \
          --project "Veld Framework" \
          --scan . \
          --format JSON \
          --out ./dependency-check-report.json \
          --enableRetired \
          --enableExperimental || true
        
        # Check for high severity vulnerabilities
        if [ -f "dependency-check-report.json" ]; then
          HIGH_VULNS=$(jq '.dependencies[] | select(.vulnerabilities[] | .severity == "HIGH") | .vulnerabilities[].name' dependency-check-report.json 2>/dev/null | wc -l || echo "0")
          
          if [ "$HIGH_VULNS" -gt "0" ]; then
            echo "âŒ Found $HIGH_VULNS high severity vulnerabilities!"
            echo "Please review the dependency-check-report.json"
            exit 1
          else
            echo "âœ… No high severity vulnerabilities found"
          fi
        fi
        
    - name: ðŸ“„ License Compliance Check
      run: |
        echo "ðŸ“„ Checking license compliance..."
        
        # Check Maven dependencies for licenses
        mvn license:check -q || echo "License check completed with warnings"
        
    - name: ðŸ“Š Upload Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-compliance-reports
        path: |
          dependency-check-report.json
        retention-days: 30

  # =============================================================================
  # STAGE 5: BUILD ARTIFACTS & PACKAGING
  # =============================================================================
  
  build-artifacts:
    name: ðŸ“¦ Build Artifacts
    runs-on: ubuntu-latest
    needs: [build-test-matrix, integration-tests, security-compliance]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ðŸ” Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
        
    - name: ðŸ” Setup GPG
      run: |
        echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
        gpg --list-secret-keys --keyid-format LONG
        
    - name: ðŸ”¨ Release Build
      env:
        GPG_TTY: $(tty)
      run: |
        echo "ðŸ”¨ Building release artifacts..."
        
        # Clean build with signing
        mvn clean deploy -DskipTests \
          -Dgpg.passphrase=${{ secrets.GPG_PASSPHRASE }} \
          -Dpgp.secretkey=${{ secrets.GPG_PRIVATE_KEY }} \
          -Dpgp.keyname=${{ secrets.GPG_KEY_ID }} || true
          
    - name: ðŸ“¦ Create Distribution Archive
      run: |
        echo "ðŸ“¦ Creating distribution archive..."
        
        # Create distribution with documentation
        mvn assembly:single -DdescriptorId=jar-with-dependencies -q || true
        
        # Create source distribution
        mvn source:jar -q || true
        
        # Create javadoc
        mvn javadoc:jar -q || true
        
    - name: ðŸ“Š Upload Release Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: release-artifacts
        path: |
          target/*-*.jar
          target/*.zip
          target/*.tar.gz
        retention-days: 90

  # =============================================================================
  # STAGE 6: DEPLOYMENT (CONDITIONAL)
  # =============================================================================
  
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-artifacts]
    if: github.ref == 'refs/heads/main' && (github.event.inputs.environment == 'staging' || github.event_name == 'push')
    environment: staging
    
    steps:
    - name: ðŸ” Download Artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-artifacts
        path: ./artifacts
        
    - name: ðŸš€ Deploy to Staging
      run: |
        echo "ðŸš€ Deploying to staging environment..."
        echo "Environment: staging"
        echo "Artifacts: $(ls -la ./artifacts/)"
        # AquÃ­ irÃ­a la lÃ³gica real de deployment a staging
        echo "âœ… Deployment to staging completed"
        
    - name: ðŸ§ª Smoke Tests
      run: |
        echo "ðŸ§ª Running smoke tests on staging..."
        # AquÃ­ irÃ­an los tests de smoke en staging
        echo "âœ… Smoke tests passed"

  deploy-production:
    name: ðŸŽ¯ Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: startsWith(github.ref, 'refs/tags/v') && github.event.inputs.environment == 'production'
    environment: production
    
    steps:
    - name: ðŸ” Download Artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-artifacts
        path: ./artifacts
        
    - name: ðŸŽ¯ Deploy to Production
      run: |
        echo "ðŸŽ¯ Deploying to production environment..."
        echo "Tag: ${{ github.ref_name }}"
        echo "Artifacts: $(ls -la ./artifacts/)"
        # AquÃ­ irÃ­a la lÃ³gica real de deployment a producciÃ³n
        echo "âœ… Deployment to production completed"
        
    - name: ðŸ“¢ Notify Deployment
      run: |
        echo "ðŸ“¢ Notifying stakeholders of successful deployment..."
        # AquÃ­ irÃ­a la lÃ³gica de notificaciÃ³n

  # =============================================================================
  # STAGE 7: NOTIFICATION & REPORTING
  # =============================================================================
  
  notification:
    name: ðŸ“¢ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [validation, build-test-matrix, integration-tests, performance-benchmarks, security-compliance, build-artifacts, deploy-staging, deploy-production]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate Pipeline Summary
      run: |
        echo "## ðŸš€ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ˆ Pipeline Status" >> $GITHUB_STEP_SUMMARY
        echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ” Validation | ${{ needs.validation.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”¨ Build & Test | ${{ needs.build-test-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”— Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| âš¡ Performance Benchmarks | ${{ needs.performance-benchmarks.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”’ Security & Compliance | ${{ needs.security-compliance.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“¦ Build Artifacts | ${{ needs.build-artifacts.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸš€ Staging Deploy | ${{ needs.deploy-staging.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŽ¯ Production Deploy | ${{ needs.deploy-production.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Determinar estado general
        FAILED_JOBS=""
        if [ "${{ needs.validation.result }}" = "failure" ]; then
          FAILED_JOBS="$FAILED_JOBS Validation,"
        fi
        if [ "${{ needs.build-test-matrix.result }}" = "failure" ]; then
          FAILED_JOBS="$FAILED_JOBS Build & Test,"
        fi
        if [ "${{ needs.security-compliance.result }}" = "failure" ]; then
          FAILED_JOBS="$FAILED_JOBS Security,"
        fi
        
        if [ -z "$FAILED_JOBS" ]; then
          echo "### âœ… Overall Status: **SUCCESS**" >> $GITHUB_STEP_SUMMARY
          echo "Pipeline completed successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Overall Status: **FAILURE**" >> $GITHUB_STEP_SUMMARY
          echo "Failed stages: ${FAILED_JOWS%?}" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs for details." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Pipeline Metrics" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Duration**: $((${{ github.run_started_at }} - ${{ github.run_created_at }})) seconds" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸ“§ Send Notification
      if: failure() && github.event_name == 'push'
      run: |
        echo "ðŸ“§ Sending failure notification..."
        # AquÃ­ irÃ­a la lÃ³gica de notificaciÃ³n por email/Slack
        echo "Notification sent for pipeline failure"
        
    - name: ðŸ“Š Archive Pipeline Data
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pipeline-execution-data
        path: |
          pipeline-summary.json
        retention-days: 90