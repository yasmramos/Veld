name: Deploy to Maven Central

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    name: Deploy to Maven Central
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
    - name: ðŸ” Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: ðŸ›¡ï¸ Verify GPG Secrets
      id: verify_gpg
      run: |
        if [ -z "${{ secrets.GPG_PRIVATE_KEY }}" ] || [ -z "${{ secrets.GPG_KEYNAME }}" ]; then
          echo "::error::Required GPG secrets (GPG_PRIVATE_KEY, GPG_KEYNAME) are not set."
          echo "Please configure these secrets in GitHub repository settings."
          echo ""
          echo "Required secrets:"
          echo "- GPG_PRIVATE_KEY: Your GPG private key"
          echo "- GPG_KEYNAME: Your GPG key ID (e.g., ABC12345)"
          echo "- GPG_PASSPHRASE: Leave empty if key has no passphrase"
          echo ""
          echo "See GITHUB_SECRETS_COMPLETE.md for detailed instructions."
          exit 1
        else
          echo "âœ… Required GPG secrets are available."
          if [ -n "${{ secrets.GPG_PASSPHRASE }}" ]; then
            echo "â„¹ï¸ GPG key has passphrase protection"
          else
            echo "â„¹ï¸ GPG key has no passphrase (will use empty passphrase)"
          fi
        fi
        
    - name: ðŸ”‘ Import GPG Key
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        echo "=== Importing GPG Key ==="
        
        # Set GPG_TTY for non-interactive mode
        export GPG_TTY=$(tty)
        
        # Import the private key
        echo "$GPG_PRIVATE_KEY" | gpg --batch --import
        echo "âœ… GPG key imported successfully"
        
        # List imported keys for verification
        echo "Available GPG keys:"
        gpg --list-keys --keyid-format LONG
        
        # Verify specific key
        echo "Verifying key ${{ secrets.GPG_KEYNAME }}..."
        if gpg --list-keys "${{ secrets.GPG_KEYNAME }}" > /dev/null 2>&1; then
          echo "âœ… Key ${{ secrets.GPG_KEYNAME }} is available and verified"
        else
          echo "âŒ Key ${{ secrets.GPG_KEYNAME }} not found!"
          exit 1
        fi
        
    - name: âš™ï¸ Create Maven Settings
      env:
        SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
        SONATYPE_TOKEN: ${{ secrets.SONATYPE_TOKEN }}
      run: |
        echo "=== Creating Maven Settings ==="
        
        mkdir -p ~/.m2
        
        cat > ~/.m2/settings.xml << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                  http://maven.apache.org/xsd/settings-1.0.0.xsd">
          <servers>
            <server>
              <id>ossrh</id>
              <username>\${env.SONATYPE_USERNAME}</username>
              <password>\${env.SONATYPE_TOKEN}</password>
            </server>
          </servers>
        </settings>
        EOF
        
        echo "âœ… Maven settings created"
        
    - name: ðŸš€ Deploy to Maven Central
      env:
        MAVEN_OPTS: "-Xmx2g -XX:+UseG1GC"
        SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
        SONATYPE_TOKEN: ${{ secrets.SONATYPE_TOKEN }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        GPG_KEYNAME: ${{ secrets.GPG_KEYNAME }}
      run: |
        echo "=== Deploying to ${{ github.event.inputs.environment || 'staging' }} ==="
        echo "Environment: ${{ github.event.inputs.environment || 'staging' }}"
        echo "Using GPG key: $GPG_KEYNAME"
        
        # Set GPG_TTY for non-interactive mode
        export GPG_TTY=$(tty)
        
        # Deploy with GPG signing
        mvn clean deploy -DskipTests=false -DfailIfNoTests=false \
          -Dgpg.executable=gpg \
          -Dgpg.keyname=$GPG_KEYNAME \
          -Dgpg.passphrase="${GPG_PASSPHRASE:-}" \
          -Dgpg.useAgent=false
          
    - name: ðŸ“Š Upload Deployment Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: deployment-artifacts-${{ github.run_number }}
        path: |
          **/target/*.jar
          **/target/*.pom
          **/target/*.asc
          **/target/*.md5
          **/target/*.sha1
        retention-days: 30
        
    - name: ðŸ“‹ Deployment Summary
      if: always()
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ github.event.inputs.environment || 'staging' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Login to Sonatype Nexus: https://s01.oss.sonatype.org/" >> $GITHUB_STEP_SUMMARY
          echo "2. Navigate to 'Staging Repositories'" >> $GITHUB_STEP_SUMMARY
          echo "3. Close and release the staging repository" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Common Issues:**" >> $GITHUB_STEP_SUMMARY
          echo "- Missing GPG key configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Invalid Sonatype credentials" >> $GITHUB_STEP_SUMMARY
          echo "- Test failures" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for specific error messages." >> $GITHUB_STEP_SUMMARY
        fi