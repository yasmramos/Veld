name: Deploy to Maven Central

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    name: Deploy to Maven Central
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
    - name: üîç Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ‚òï Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: üõ°Ô∏è Verify GPG Secrets
      id: verify_gpg
      run: |
        if [ -z "${{ secrets.GPG_PRIVATE_KEY }}" ] || [ -z "${{ secrets.GPG_KEYNAME }}" ]; then
          echo "::error::Required GPG secrets (GPG_PRIVATE_KEY, GPG_KEYNAME) are not set."
          echo "Please configure these secrets in GitHub repository settings."
          echo ""
          echo "Required secrets:"
          echo "- GPG_PRIVATE_KEY: Your GPG private key"
          echo "- GPG_KEYNAME: Your GPG key ID (e.g., ABC12345)"
          echo "- GPG_PASSPHRASE: Leave empty if key has no passphrase"
          echo ""
          echo "See GITHUB_SECRETS_COMPLETE.md for detailed instructions."
          exit 1
        else
          echo "‚úÖ Required GPG secrets are available."
          if [ -n "${{ secrets.GPG_PASSPHRASE }}" ]; then
            echo "‚ÑπÔ∏è GPG key has passphrase protection"
          else
            echo "‚ÑπÔ∏è GPG key has no passphrase (will use empty passphrase)"
          fi
        fi
        
    - name: üîë Import GPG Key
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        echo "=== Importing GPG Key ==="
        
        # Set GPG_TTY for non-interactive mode
        export GPG_TTY=$(tty)
        
        # Import the private key (base64 encoded)
        echo "$GPG_PRIVATE_KEY" | base64 -d | gpg --batch --import
        echo "‚úÖ GPG key imported successfully"
        
        # List imported keys for verification
        echo "Available GPG keys:"
        gpg --list-keys --keyid-format LONG
        
        # Verify specific key
        echo "Verifying key ${{ secrets.GPG_KEYNAME }}..."
        if gpg --list-keys "${{ secrets.GPG_KEYNAME }}" > /dev/null 2>&1; then
          echo "‚úÖ Key ${{ secrets.GPG_KEYNAME }} is available and verified"
        else
          echo "‚ùå Key ${{ secrets.GPG_KEYNAME }} not found!"
          exit 1
        fi
        
    - name: Create Maven Settings
      env:
        SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
        SONATYPE_TOKEN: ${{ secrets.SONATYPE_TOKEN }}
      run: |
        echo "=== Creating Maven Settings ==="

        mkdir -p ~/.m2

        echo '<?xml version="1.0" encoding="UTF-8"?>' > ~/.m2/settings.xml
        echo '<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"' >> ~/.m2/settings.xml
        echo '          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"' >> ~/.m2/settings.xml
        echo '          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0' >> ~/.m2/settings.xml
        echo '          http://maven.apache.org/xsd/settings-1.0.0.xsd">' >> ~/.m2/settings.xml
        echo '  <servers>' >> ~/.m2/settings.xml
        echo '    <server>' >> ~/.m2/settings.xml
        echo '      <id>ossrh</id>' >> ~/.m2/settings.xml
        echo "      <username>$SONATYPE_USERNAME</username>" >> ~/.m2/settings.xml
        echo "      <password>$SONATYPE_TOKEN</password>" >> ~/.m2/settings.xml
        echo '    </server>' >> ~/.m2/settings.xml
        echo '  </servers>' >> ~/.m2/settings.xml
        echo '</settings>' >> ~/.m2/settings.xml

        echo "Maven settings created"
        
    - name: üöÄ Deploy to Maven Central
      env:
        MAVEN_OPTS: "-Xmx2g -XX:+UseG1GC"
        SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
        SONATYPE_TOKEN: ${{ secrets.SONATYPE_TOKEN }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        GPG_KEYNAME: ${{ secrets.GPG_KEYNAME }}
      run: |
        echo "=== Deploying to ${{ github.event.inputs.environment || 'staging' }} ==="
        echo "Environment: ${{ github.event.inputs.environment || 'staging' }}"
        echo "Using GPG key: $GPG_KEYNAME"
        
        # Set GPG_TTY for non-interactive mode
        export GPG_TTY=$(tty)
        
        # Deploy with GPG signing
        mvn clean deploy -DskipTests=false -DfailIfNoTests=false \
          -DskipGpg=false \
          -Dgpg.executable=gpg \
          -Dgpg.keyname=$GPG_KEYNAME \
          -Dgpg.passphrase="${GPG_PASSPHRASE:-}" \
          -Dgpg.useAgent=false
          
    - name: üìä Upload Deployment Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: deployment-artifacts-${{ github.run_number }}
        path: |
          **/target/*.jar
          **/target/*.pom
          **/target/*.asc
          **/target/*.md5
          **/target/*.sha1
        retention-days: 30
        
    - name: üìã Deployment Summary
      if: always()
      run: |
        echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ github.event.inputs.environment || 'staging' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "### ‚úÖ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Login to Sonatype Nexus: https://s01.oss.sonatype.org/" >> $GITHUB_STEP_SUMMARY
          echo "2. Navigate to 'Staging Repositories'" >> $GITHUB_STEP_SUMMARY
          echo "3. Close and release the staging repository" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ùå Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Common Issues:**" >> $GITHUB_STEP_SUMMARY
          echo "- Missing GPG key configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Invalid Sonatype credentials" >> $GITHUB_STEP_SUMMARY
          echo "- Test failures" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for specific error messages." >> $GITHUB_STEP_SUMMARY
        fi