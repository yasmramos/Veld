name: üîê Security & Compliance Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [ main ]

jobs:
  security-compliance:
    runs-on: ubuntu-latest
    
    steps:
    - name: üîç Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: üîê Verify Commit Signatures
      run: |
        echo "üîê Verifying commit signatures..."
        
        # Verificar si todos los commits est√°n firmados
        COMMITS=$(git rev-list --count HEAD)
        SIGNED_COMMITS=$(git log --pretty=format:"%G?" | grep -c "^G" || echo "0")
        
        echo "Total commits: $COMMITS"
        echo "Signed commits: $SIGNED_COMMITS"
        
        if [ "$COMMITS" -gt "$SIGNED_COMMITS" ]; then
          echo "‚ùå Not all commits are signed with GPG"
          echo "Unsigned commits found:"
          git log --pretty=format:"%H %s %G?" | grep -v "^G"
          exit 1
        else
          echo "‚úÖ All commits are properly signed"
        fi
        
    - name: üîç Check Linear History
      run: |
        echo "üîç Checking for merge commits..."
        
        # Verificar que no haya merge commits en la rama de feature
        MERGE_COMMITS=$(git log --oneline --merges --count HEAD 2>/dev/null || echo "0")
        
        if [ "$MERGE_COMMITS" -gt "0" ]; then
          echo "‚ùå Merge commits found in PR"
          echo "Merge commits:"
          git log --oneline --merges HEAD
          echo ""
          echo "Please use 'git rebase' instead of 'git merge' to maintain linear history"
          exit 1
        else
          echo "‚úÖ Linear history maintained (no merge commits)"
        fi
        
    - name: üè∑Ô∏è Validate PR Title Format
      run: |
        echo "üè∑Ô∏è Validating PR title format..."
        
        PR_TITLE="${{ github.event.pull_request.title }}"
        echo "PR Title: $PR_TITLE"
        
        # Verificar formato Conventional Commits
        if echo "$PR_TITLE" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+"; then
          echo "‚úÖ PR title follows Conventional Commits format"
        else
          echo "‚ùå PR title doesn't follow Conventional Commits format"
          echo ""
          echo "Expected format: <type>(<scope>): <description>"
          echo "Examples:"
          echo "  feat: add new dependency injection feature"
          echo "  fix: resolve NPE in container initialization"
          echo "  docs: update API documentation"
          echo ""
          echo "Allowed types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"
          exit 1
        fi
        
    - name: üîç Check File Naming Conventions
      run: |
        echo "üîç Checking file naming conventions..."
        
        # Verificar archivos Java
        INVALID_JAVA_FILES=$(find . -name "*.java" | grep -E ".*[A-Z].*[_-].*\.java$|.*[_-].*[A-Z].*\.java$" || true)
        
        if [ -n "$INVALID_JAVA_FILES" ]; then
          echo "‚ùå Invalid Java file naming detected:"
          echo "$INVALID_JAVA_FILES"
          echo ""
          echo "Java files should follow camelCase naming convention"
          exit 1
        else
          echo "‚úÖ All Java files follow naming conventions"
        fi
        
        # Verificar archivos de configuraci√≥n
        INVALID_CONFIG_FILES=$(find . -name "*.yml" -o -name "*.yaml" -o -name "*.json" | grep -E ".*[A-Z].*\.(yml|yaml|json)$|.*[_-].*[A-Z].*\.(yml|yaml|json)$" || true)
        
        if [ -n "$INVALID_CONFIG_FILES" ]; then
          echo "‚ùå Invalid config file naming detected:"
          echo "$INVALID_CONFIG_FILES"
          echo ""
          echo "Config files should use kebab-case or snake_case"
          exit 1
        else
          echo "‚úÖ All config files follow naming conventions"
        fi
        
    - name: üîç Check Sensitive Information
      run: |
        echo "üîç Checking for sensitive information..."
        
        # Verificar patrones comunes de informaci√≥n sensible
        SENSITIVE_PATTERNS=(
          "password\s*=\s*[\"'][^\"']*[\"']"
          "api[_-]?key\s*=\s*[\"'][^\"']*[\"']"
          "secret\s*=\s*[\"'][^\"']*[\"']"
          "token\s*=\s*[\"'][^\"']*[\"']"
          "private[_-]?key\s*=\s*[\"'][^\"']*[\"']"
        )
        
        FOUND_SENSITIVE=false
        for pattern in "${SENSITIVE_PATTERNS[@]}"; do
          if grep -riE "$pattern" . --exclude-dir=.git --exclude-dir=target --exclude="*.jar" --exclude="*.png" --exclude="*.jpg" 2>/dev/null; then
            FOUND_SENSITIVE=true
          fi
        done
        
        if [ "$FOUND_SENSITIVE" = true ]; then
          echo "‚ùå Potential sensitive information detected"
          echo "Please review and remove any hardcoded passwords, API keys, or secrets"
          exit 1
        else
          echo "‚úÖ No sensitive information detected"
        fi
        
    - name: üìù Generate Compliance Report
      run: |
        PR_NUMBER="${{ github.event.pull_request.number }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        AUTHOR="${{ github.event.pull_request.user.login }}"
        
        REPORT="## üîê Security & Compliance Report
        
### üìä PR Information
- **Number**: #$PR_NUMBER
- **Title**: $PR_TITLE
- **Author**: @$AUTHOR
- **Branch**: ${{ github.event.pull_request.head.ref }}
- **Base**: ${{ github.event.pull_request.base.ref }}
        
### ‚úÖ Compliance Checks
- [x] **Commit Signatures**: All commits GPG signed
- [x] **Linear History**: No merge commits in PR branch
- [x] **PR Title Format**: Conventional Commits format
- [x] **File Naming**: Java and config files follow conventions
- [x] **Sensitive Data**: No hardcoded secrets detected
        
### üéØ Summary
All security and compliance checks have passed. This PR meets the required standards for merge.
        
---
*Generated by Security & Compliance Check*"
        
        if [ -n "$PR_NUMBER" ]; then
          gh pr comment $PR_NUMBER --body "$REPORT"
        fi
        
        echo "$REPORT"
        
  license-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: üîç Checkout Repository
      uses: actions/checkout@v4
      
    - name: üìÑ Check License Headers
      run: |
        echo "üìÑ Checking license headers in Java files..."
        
        # Patr√≥n para buscar encabezados de licencia (ejemplo)
        LICENSE_PATTERN="Copyright.*Veld|Apache License|MIT License"
        
        MISSING_LICENSE_FILES=""
        for file in $(find . -name "*.java" -not -path "./target/*" -not -path "./.git/*"); do
          if ! grep -q "$LICENSE_PATTERN" "$file" 2>/dev/null; then
            MISSING_LICENSE_FILES="$MISSING_LICENSE_FILES\n$file"
          fi
        done
        
        if [ -n "$MISSING_LICENSE_FILES" ]; then
          echo "‚ùå Some Java files are missing license headers:"
          echo -e "$MISSING_LICENSE_FILES"
          echo ""
          echo "Please add appropriate license headers to all Java files"
        else
          echo "‚úÖ All Java files have license headers"
        fi
        
  dependency-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: üîç Checkout Repository
      uses: actions/checkout@v4
      
    - name: ‚òï Setup JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
        
    - name: üîç Maven Dependency Analysis
      run: |
        echo "üîç Analyzing Maven dependencies..."
        
        # Verificar dependencias usando Maven Enforcer Plugin
        mvn dependency:tree -DoutputFile=dependency-tree.txt -q
        
        echo "‚úÖ Dependency tree generated"
        echo "Review dependency-tree.txt for any unusual dependencies"
        
    - name: üõ°Ô∏è OWASP Dependency Check
      run: |
        echo "üõ°Ô∏è Running OWASP Dependency Check..."
        
        # Descargar y ejecutar OWASP Dependency Check
        wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v9.0.9/dependency-check-9.0.9-release.zip
        unzip -q dependency-check-9.0.9-release.zip
        
        ./dependency-check/bin/dependency-check.sh \
          --project "Veld Framework" \
          --scan . \
          --format JSON \
          --out ./dependency-check-report.json \
          --enableRetired \
          --enableExperimental || true
        
        if [ -f "dependency-check-report.json" ]; then
          echo "‚úÖ OWASP dependency check completed"
          echo "üìä Report saved to dependency-check-report.json"
          
          # Extraer summary del reporte
          VULNERABILITIES=$(jq '.dependencies[] | select(.vulnerabilities | length > 0) | .vulnerabilities[].name' dependency-check-report.json 2>/dev/null | wc -l || echo "0")
          
          if [ "$VULNERABILITIES" -gt "0" ]; then
            echo "‚ö†Ô∏è Found $VULNERABILITIES potential vulnerabilities"
            echo "Please review the dependency-check-report.json file"
          else
            echo "‚úÖ No known vulnerabilities found in dependencies"
          fi
        fi