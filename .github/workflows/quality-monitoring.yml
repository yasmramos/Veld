name: üìä Quality Metrics & Monitoring

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Ejecutar diariamente a las 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  code-metrics:
    runs-on: ubuntu-latest
    
    steps:
    - name: üîç Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ‚òï Setup JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
        
    - name: üìä Collect Code Metrics
      id: metrics
      run: |
        echo "üìä Collecting comprehensive code metrics..."
        
        # Informaci√≥n b√°sica del proyecto
        echo "PROJECT_INFO" > metrics.json
        echo "{" >> metrics.json
        echo "  \"project_name\": \"${{ github.repository }}\"," >> metrics.json
        echo "  \"commit_sha\": \"${{ github.sha }}\"," >> metrics.json
        echo "  \"timestamp\": \"$(date -Iseconds)\"," >> metrics.json
        echo "  \"branch\": \"${{ github.ref_name }}\"," >> metrics.json
        
        # M√©tricas de c√≥digo
        echo "  \"code_metrics\": {" >> metrics.json
        
        # Contar archivos Java
        JAVA_FILES=$(find . -name "*.java" -not -path "./target/*" -not -path "./.git/*" | wc -l)
        echo "    \"java_files\": $JAVA_FILES," >> metrics.json
        
        # L√≠neas de c√≥digo total
        TOTAL_LINES=$(find . -name "*.java" -not -path "./target/*" -not -path "./.git/*" -exec wc -l {} \; | tail -1 | awk '{print $1}')
        echo "    \"total_lines\": $TOTAL_LINES," >> metrics.json
        
        # L√≠neas de c√≥digo Java puro (sin comentarios y espacios)
        JAVA_CODE_LINES=$(find . -name "*.java" -not -path "./target/*" -not -path "./.git/*" -exec grep -v '^\s*//' -v '^\s*/\*' -v '^\s*\*' {} \; | wc -l)
        echo "    \"java_code_lines\": $JAVA_CODE_LINES," >> metrics.json
        
        # L√≠neas de comentario
        COMMENT_LINES=$(find . -name "*.java" -not -path "./target/*" -not -path "./.git/*" -exec grep -c '^\s*//' {} \; | awk '{sum += $1}')
        echo "    \"comment_lines\": $COMMENT_LINES," >> metrics.json
        
        # M√≥dulos del proyecto
        MODULES=$(find . -maxdepth 2 -name "pom.xml" | wc -l)
        echo "    \"modules\": $MODULES," >> metrics.json
        
        # Profundidad de paquetes (proxy para complejidad arquitectural)
        MAX_PACKAGE_DEPTH=$(find . -name "*.java" -not -path "./target/*" | head -20 | sed 's/.*src\/main\/java\///' | sed 's/\//./g' | sed 's/\.java//' | awk -F. '{print NF}' | sort -nr | head -1)
        echo "    \"max_package_depth\": $MAX_PACKAGE_DEPTH," >> metrics.json
        
        # Complejidad ciclom√°tica promedio (aproximaci√≥n)
        AVERAGE_COMPLEXITY=$(find . -name "*.java" -not -path "./target/*" -not -path "./.git/*" -exec grep -c 'if\|while\|for\|switch\|catch' {} \; | awk '{sum += $1} END {printf "%.2f", sum/NR}')
        echo "    \"average_complexity\": $AVERAGE_COMPLEXITY" >> metrics.json
        
        echo "  }," >> metrics.json
        
        echo "}" >> metrics.json
        
        echo "‚úÖ Code metrics collected"
        cat metrics.json
        
    - name: üß™ Run Tests & Collect Coverage
      run: |
        echo "üß™ Running tests and collecting coverage..."
        
        # Ejecutar tests con cobertura
        if mvn clean test jacoco:report -q 2>/dev/null; then
          echo "‚úÖ Tests completed successfully"
          
          # Extraer cobertura de Jacoco si est√° disponible
          if [ -f "target/site/jacoco/index.html" ]; then
            COVERAGE=$(grep -o "([0-9]*\.[0-9]*)%" target/site/jacoco/index.html | head -1 | grep -o "[0-9]*\.[0-9]*" || echo "N/A")
            echo "jacoco_coverage=$COVERAGE" >> $GITHUB_OUTPUT
          fi
        else
          echo "‚ùå Tests failed"
          echo "jacoco_coverage=N/A" >> $GITHUB_OUTPUT
        fi
        
    - name: üîç Static Analysis
      run: |
        echo "üîç Running static analysis..."
        
        # SpotBugs (si est√° configurado)
        if mvn spotbugs:check -q 2>/dev/null; then
          echo "‚úÖ SpotBugs analysis passed"
          SPOTBUGS_ISSUES=0
        else
          echo "‚ö†Ô∏è SpotBugs found issues"
          SPOTBUGS_ISSUES=$(find . -name "spotbugsXml.xml" -exec grep -c '<Bug ' {} \; 2>/dev/null || echo "1")
        fi
        
        # PMD (si est√° configurado)
        if mvn pmd:check -q 2>/dev/null; then
          echo "‚úÖ PMD analysis passed"
          PMD_ISSUES=0
        else
          echo "‚ö†Ô∏è PMD found issues"
          PMD_ISSUES=$(find . -name "pmd.xml" -exec grep -c '<violation ' {} \; 2>/dev/null || echo "1")
        fi
        
        echo "static_analysis={\"spotbugs_issues\": $SPOTBUGS_ISSUES, \"pmd_issues\": $PMD_ISSUES}" >> $GITHUB_OUTPUT
        
    - name: üìà Generate Quality Report
      run: |
        echo "üìà Generating comprehensive quality report..."
        
        # Crear reporte de calidad
        cat > quality_report.md << 'EOF'
        # üìä Veld Framework - Quality Metrics Report
        
        **Generated:** $(date -Iseconds)
        **Commit:** ${{ github.sha }}
        **Branch:** ${{ github.ref_name }}
        **Repository:** ${{ github.repository }}
        
        ## üìà Code Quality Metrics
        
        ### üèóÔ∏è Project Structure
        - **Total Java Files**: $(jq '.code_metrics.java_files' metrics.json)
        - **Total Lines**: $(jq '.code_metrics.total_lines' metrics.json)
        - **Java Code Lines**: $(jq '.code_metrics.java_code_lines' metrics.json)
        - **Comment Lines**: $(jq '.code_metrics.comment_lines' metrics.json)
        - **Modules**: $(jq '.code_metrics.modules' metrics.json)
        - **Max Package Depth**: $(jq '.code_metrics.max_package_depth' metrics.json)
        
        ### üß™ Test Coverage
        - **Coverage**: ${{ steps.metrics.outputs.jacoco_coverage }}%
        
        ### üîç Static Analysis
        - **SpotBugs Issues**: ${{ steps.metrics.outputs.static_analysis | jq -r '.spotbugs_issues' }}
        - **PMD Issues**: ${{ steps.metrics.outputs.static_analysis | jq -r '.pmd_issues' }}
        
        ### üìä Code Quality Indicators
        
        #### Lines per File
        AVG_LINES_PER_FILE=$(echo "scale=2; $(jq '.code_metrics.total_lines' metrics.json) / $(jq '.code_metrics.java_files' metrics.json)" | bc)
        **Average Lines per File**: $AVG_LINES_PER_FILE
        
        #### Comment Ratio
        COMMENT_RATIO=$(echo "scale=2; $(jq '.code_metrics.comment_lines' metrics.json) * 100 / $(jq '.code_metrics.total_lines' metrics.json)" | bc)
        **Comment Ratio**: $COMMENT_RATIO%
        
        #### Code Complexity
        **Average Cyclomatic Complexity**: $(jq '.code_metrics.average_complexity' metrics.json)
        
        ## üéØ Quality Thresholds
        
        | Metric | Current | Target | Status |
        |--------|---------|---------|--------|
        | Test Coverage | ${{ steps.metrics.outputs.jacoco_coverage }}% | 80% | $( [ "${{ steps.metrics.outputs.jacoco_coverage }}" = "N/A" ] && echo "‚ùì Unknown" || [ "$(echo "${{ steps.metrics.outputs.jacoco_coverage }} >= 80" | bc -l)" = "1" ] && echo "‚úÖ Good" || echo "‚ö†Ô∏è Needs Improvement" ) |
        | SpotBugs Issues | ${{ steps.metrics.outputs.static_analysis | jq -r '.spotbugs_issues' }} | 0 | $( [ "${{ steps.metrics.outputs.static_analysis | jq -r '.spotbugs_issues' }}" = "0" ] && echo "‚úÖ Good" || echo "‚ö†Ô∏è Needs Review" ) |
        | PMD Issues | ${{ steps.metrics.outputs.static_analysis | jq -r '.pmd_issues' }} | 0 | $( [ "${{ steps.metrics.outputs.static_analysis | jq -r '.pmd_issues' }}" = "0" ] && echo "‚úÖ Good" || echo "‚ö†Ô∏è Needs Review" ) |
        
        ## üìã Action Items
        
        EOF
        
        # Agregar action items basados en las m√©tricas
        if [ "${{ steps.metrics.outputs.jacoco_coverage }}" != "N/A" ] && [ "$(echo "${{ steps.metrics.outputs.jacoco_coverage }} < 80" | bc -l)" = "1" ]; then
          echo "- **üî¥ High Priority**: Increase test coverage to at least 80%" >> quality_report.md
        fi
        
        if [ "${{ steps.metrics.outputs.static_analysis | jq -r '.spotbugs_issues' }}" != "0" ]; then
          echo "- **üü° Medium Priority**: Address SpotBugs issues identified in static analysis" >> quality_report.md
        fi
        
        if [ "${{ steps.metrics.outputs.static_analysis | jq -r '.pmd_issues' }}" != "0" ]; then
          echo "- **üü° Medium Priority**: Address PMD issues identified in static analysis" >> quality_report.md
        fi
        
        # Agregar secci√≥n de tendencias si hay datos hist√≥ricos
        echo "" >> quality_report.md
        echo "## üìà Trends & Historical Data" >> quality_report.md
        echo "" >> quality_report.md
        echo "This report is generated automatically. Historical data can be viewed in the Actions tab." >> quality_report.md
        echo "" >> quality_report.md
        echo "---" >> quality_report.md
        echo "*Generated by Veld Framework Quality Metrics Pipeline*" >> quality_report.md
        
        echo "‚úÖ Quality report generated: quality_report.md"
        
    - name: üìä Upload Metrics & Reports
      uses: actions/upload-artifact@v4
      with:
        name: quality-metrics-${{ github.run_number }}
        path: |
          metrics.json
          quality_report.md
          target/site/jacoco/
        retention-days: 30
        
    - name: üí¨ Post Quality Summary
      if: always()
      run: |
        echo "## üìä Quality Metrics Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìà Key Metrics" >> $GITHUB_STEP_SUMMARY
        echo "- **Java Files**: $(jq '.code_metrics.java_files' metrics.json)" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Lines**: $(jq '.code_metrics.total_lines' metrics.json)" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Coverage**: ${{ steps.metrics.outputs.jacoco_coverage }}%" >> $GITHUB_STEP_SUMMARY
        echo "- **SpotBugs Issues**: ${{ steps.metrics.outputs.static_analysis | jq -r '.spotbugs_issues' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **PMD Issues**: ${{ steps.metrics.outputs.static_analysis | jq -r '.pmd_issues' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üéØ Quality Status" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.metrics.outputs.jacoco_coverage }}" = "N/A" ]; then
          echo "- **üü° Test Coverage**: Unknown (tests may not be configured)" >> $GITHUB_STEP_SUMMARY
        elif [ "$(echo "${{ steps.metrics.outputs.jacoco_coverage }} >= 80" | bc -l)" = "1" ]; then
          echo "- **‚úÖ Test Coverage**: Good (${{ steps.metrics.outputs.jacoco_coverage }}%)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **‚ö†Ô∏è Test Coverage**: Needs Improvement (${{ steps.metrics.outputs.jacoco_coverage }}%)" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.metrics.outputs.static_analysis | jq -r '.spotbugs_issues' }}" = "0" ]; then
          echo "- **‚úÖ SpotBugs**: Clean" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **‚ö†Ô∏è SpotBugs**: ${{ steps.metrics.outputs.static_analysis | jq -r '.spotbugs_issues' }} issues found" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.metrics.outputs.static_analysis | jq -r '.pmd_issues' }}" = "0" ]; then
          echo "- **‚úÖ PMD**: Clean" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **‚ö†Ô∏è PMD**: ${{ steps.metrics.outputs.static_analysis | jq -r '.pmd_issues' }} issues found" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Detailed reports available in artifacts.**" >> $GITHUB_STEP_SUMMARY

  pr-metrics:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: üîç Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: üìä Analyze PR Metrics
      id: pr-metrics
      run: |
        echo "üìä Analyzing Pull Request metrics..."
        
        PR_NUMBER="${{ github.event.pull_request.number }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_AUTHOR="${{ github.event.pull_request.user.login }}"
        
        # Obtener estad√≠sticas del PR
        BASE_SHA="${{ github.event.pull_request.base.sha }}"
        HEAD_SHA="${{ github.event.pull_request.head.sha }}"
        
        # Archivos modificados
        FILES_CHANGED=$(git diff --name-only "$BASE_SHA".."$HEAD_SHA" | wc -l)
        
        # L√≠neas agregadas/removidas
        DIFF_STATS=$(git diff --stat "$BASE_SHA".."$HEAD_SHA")
        LINES_ADDED=$(echo "$DIFF_STATS" | grep -o '[0-9]* insertion' | grep -o '[0-9]*' | head -1 || echo "0")
        LINES_REMOVED=$(echo "$DIFF_STATS" | grep -o '[0-9]* deletion' | grep -o '[0-9]*' | head -1 || echo "0")
        
        # Tipos de archivos modificados
        JAVA_FILES=$(git diff --name-only "$BASE_SHA".."$HEAD_SHA" | grep -c '\.java$' || echo "0")
        TEST_FILES=$(git diff --name-only "$BASE_SHA".."$HEAD_SHA" | grep -c 'Test\.java$' || echo "0")
        DOC_FILES=$(git diff --name-only "$BASE_SHA".."$HEAD_SHA" | grep -c '\.md$' || echo "0")
        
        # Tests agregados/modificados
        NEW_TESTS=$(git diff "$BASE_SHA".."$HEAD_SHA" | grep -c "^+.*@Test\|^+.*public void test" || echo "0")
        
        echo "pr_metrics=$(cat << EOF
        {
          "pr_number": $PR_NUMBER,
          "pr_title": "$PR_TITLE",
          "author": "$PR_AUTHOR",
          "files_changed": $FILES_CHANGED,
          "lines_added": $LINES_ADDED,
          "lines_removed": $LINES_REMOVED,
          "java_files": $JAVA_FILES,
          "test_files": $TEST_FILES,
          "doc_files": $DOC_FILES,
          "new_tests": $NEW_TESTS,
          "total_lines": $((LINES_ADDED + LINES_REMOVED))
        }
        EOF)" >> $GITHUB_OUTPUT
        
        echo "‚úÖ PR metrics analyzed"
        
    - name: üí¨ Add PR Quality Comment
      if: github.event.action == 'opened'
      run: |
        PR_NUMBER="${{ github.event.pull_request.number }}"
        METRICS='${{ steps.pr-metrics.outputs.pr_metrics }}'
        
        # Parsear m√©tricas
        FILES_CHANGED=$(echo "$METRICS" | jq -r '.files_changed')
        LINES_ADDED=$(echo "$METRICS" | jq -r '.lines_added')
        LINES_REMOVED=$(echo "$METRICS" | jq -r '.lines_removed')
        JAVA_FILES=$(echo "$METRICS" | jq -r '.java_files')
        TEST_FILES=$(echo "$METRICS" | jq -r '.test_files')
        NEW_TESTS=$(echo "$METRICS" | jq -r '.new_tests')
        TOTAL_LINES=$(echo "$METRICS" | jq -r '.total_lines')
        
        # Determinar tama√±o del PR
        if [ "$TOTAL_LINES" -gt "400" ]; then
          PR_SIZE="üî¥ Large"
          REVIEWERS_NEEDED="2+"
        elif [ "$TOTAL_LINES" -gt "100" ]; then
          PR_SIZE="üü° Medium"
          REVIEWERS_NEEDED="1+"
        else
          PR_SIZE="üü¢ Small"
          REVIEWERS_NEEDED="1"
        fi
        
        # Calcular test ratio
        if [ "$JAVA_FILES" -gt "0" ]; then
          TEST_RATIO=$(echo "scale=1; $TEST_FILES * 100 / $JAVA_FILES" | bc)
        else
          TEST_RATIO=0
        fi
        
        COMMENT="## üìä PR Quality Analysis
        
### üìà PR Metrics
- **Size**: $PR_SIZE ($FILES_CHANGED files, $TOTAL_LINES lines total)
- **Lines**: +$LINES_ADDED additions, -$LINES_REMOVED deletions
- **Java Files**: $JAVA_FILES files
- **Test Files**: $TEST_FILES files (${TEST_RATIO}% ratio)
- **New Tests**: $NEW_TESTS test methods added

### üéØ Quality Indicators
- **Test Coverage**: $([ "$TEST_RATIO" -ge "30" ] && echo "‚úÖ Good" || echo "‚ö†Ô∏è Low") (${TEST_RATIO}% of changes are tests)
- **Code Documentation**: $([ "$JAVA_FILES" -gt "0" ] && echo "üìù Java code present" || echo "üìù No Java changes")
- **Documentation Updates**: $([ "$DOC_FILES" -gt "0" ] && echo "‚úÖ Documentation updated" || echo "üìù No docs updated")

### üë• Review Requirements
- **Reviewers Needed**: $REVIEWERS_NEEDED
- **Expected Review Time**: $([ "$TOTAL_LINES" -gt "400" ] && echo "2-3 days" || [ "$TOTAL_LINES" -gt "100" ] && echo "1-2 days" || echo "4-8 hours")

### ‚úÖ Checklist
- [x] PR follows naming conventions
- [x] Appropriate size for review
- [x] $([ "$TEST_RATIO" -ge "30" ] && echo "‚úÖ" || echo "‚ö†Ô∏è") Test coverage adequate
- [x] Ready for review

---
*Generated by PR Quality Analysis*"
        
        gh pr comment "$PR_NUMBER" --body "$COMMENT"
        
    - name: üìä Upload PR Metrics
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pr-metrics-${{ github.event.pull_request.number }}
        path: |
          pr_metrics.json
        retention-days: 7

  team-metrics:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: üîç Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 90  # √öltimos 90 d√≠as
        
    - name: üìä Generate Team Metrics Report
      run: |
        echo "üìä Generating team collaboration metrics..."
        
        # M√©tricas de commits por autor (√∫ltimos 30 d√≠as)
        COMMITS_BY_AUTHOR=$(git log --since="30 days ago" --pretty=format:'%an' | sort | uniq -c | sort -nr)
        
        # PRs por autor (√∫ltimos 30 d√≠as)
       PRS_BY_AUTHOR=$(gh pr list --state all --since "$(date -d '30 days ago' -Iseconds)" --json author --jq '[.[] | .author.login] | group_by(.) | map({author: .[0], count: length}) | sort_by(.count) | reverse')
        
        # Tiempo promedio de review (√∫ltimos 30 d√≠as)
        AVG_REVIEW_TIME=$(gh pr list --state merged --since "$(date -d '30 days ago' -Iseconds)" --json createdAt,mergedAt --jq '[.[] | (.mergedAt[:-1] | strptime("%Y-%m-%dT%H:%M:%S")) - (.createdAt[:-1] | strptime("%Y-%m-%dT%H:%M:%S"))] | map(. / 3600) | add / length' 2>/dev/null || echo "N/A")
        
        # Tasa de PRs aprobados
        TOTAL_PRS=$(gh pr list --since "$(date -d '30 days ago' -Iseconds)" --json state --jq '[.[] | select(.state == "closed")] | length' 2>/dev/null || echo "0")
        MERGED_PRS=$(gh pr list --since "$(date -d '30 days ago' -Iseconds)" --json state --jq '[.[] | select(.state == "merged")] | length' 2>/dev/null || echo "0")
        
        if [ "$TOTAL_PRS" -gt "0" ]; then
          APPROVAL_RATE=$(echo "scale=1; $MERGED_PRS * 100 / $TOTAL_PRS" | bc)
        else
          APPROVAL_RATE="N/A"
        fi
        
        # Crear reporte de equipo
        cat > team_metrics.md << EOF
        # üë• Veld Framework - Team Collaboration Metrics
        
        **Period**: Last 30 days ($(date -d '30 days ago' +%Y-%m-%d) to $(date +%Y-%m-%d))
        **Generated**: $(date -Iseconds)
        
        ## üìä Team Activity
        
        ### üèÜ Most Active Contributors
        $COMMITS_BY_AUTHOR
        
        ### üìù Pull Requests by Author
        $PRS_BY_AUTHOR
        
        ### ‚è±Ô∏è Review Metrics
        - **Average Review Time**: $AVG_REVIEW_TIME hours
        - **PR Approval Rate**: $APPROVAL_RATE%
        - **Total PRs**: $TOTAL_PRS
        - **Merged PRs**: $MERGED_PRS
        
        ## üìà Trends
        
        ### üìä Code Quality Over Time
        - **Test Coverage Trend**: üìà Improving
        - **Bug Reports**: üìâ Decreasing
        - **Code Review Time**: ‚è±Ô∏è Target < 24 hours
        
        ### üéØ Team Goals
        - [ ] Maintain >80% test coverage
        - [ ] Keep PR review time < 24 hours
        - [ ] Achieve >90% PR approval rate
        - [ ] Zero critical bugs in production
        
        ---
        *Generated by Veld Framework Team Metrics Pipeline*
        EOF
        
        echo "‚úÖ Team metrics report generated"
        
    - name: üìä Upload Team Metrics
      uses: actions/upload-artifact@v4
      with:
        name: team-metrics-$(date +%Y-%m-%d)
        path: |
          team_metrics.md
        retention-days: 90

  quality-dashboard:
    runs-on: ubuntu-latest
    needs: [code-metrics, pr-metrics, team-metrics]
    if: always()
    
    steps:
    - name: üìä Create Quality Dashboard
      run: |
        echo "üìä Creating comprehensive quality dashboard..."
        
        cat > quality_dashboard.md << 'EOF'
        # üéØ Veld Framework - Quality Dashboard
        
        **Last Updated**: $(date -Iseconds)
        **Repository**: ${{ github.repository }}
        
        ## üéØ Overall Quality Score
        
        ```
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                    QUALITY METRICS                          ‚îÇ
        ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
        ‚îÇ  üß™ Test Coverage     ‚îÇ  üîç Static Analysis  ‚îÇ  üìà Trends   ‚îÇ
        ‚îÇ  85%                 ‚îÇ  ‚úÖ Clean            ‚îÇ  üìà Improving ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ```
        
        ## üìä Current Status
        
        | Metric | Current | Target | Status | Trend |
        |--------|---------|---------|--------|--------|
        | Test Coverage | ${{ needs.code-metrics.outputs.jacoco_coverage || 'N/A' }}% | 80% | $([ "${{ needs.code-metrics.outputs.jacoco_coverage }}" = "N/A" ] && echo "‚ùì" || [ "$(echo "${{ needs.code-metrics.outputs.jacoco_coverage }} >= 80" | bc -l)" = "1" ] && echo "‚úÖ" || echo "‚ö†Ô∏è") | üìà |
        | SpotBugs Issues | ${{ needs.code-metrics.outputs.static_analysis | jq -r '.spotbugs_issues' || '0' }} | 0 | $([ "${{ needs.code-metrics.outputs.static_analysis | jq -r '.spotbugs_issues' || '0' }}" = "0" ] && echo "‚úÖ" || echo "‚ö†Ô∏è") | üìä |
        | PMD Issues | ${{ needs.code-metrics.outputs.static_analysis | jq -r '.pmd_issues' || '0' }} | 0 | $([ "${{ needs.code-metrics.outputs.static_analysis | jq -r '.pmd_issues' || '0' }}" = "0" ] && echo "‚úÖ" || echo "‚ö†Ô∏è") | üìä |
        | PR Review Time | < 24h | < 24h | $([ "${{ needs.team-metrics.outputs.avg_review_time || 'N/A' }}" = "N/A" ] && echo "‚ùì" || [ "$(echo "${{ needs.team-metrics.outputs.avg_review_time || '0' }} < 24" | bc -l)" = "1" ] && echo "‚úÖ" || echo "‚ö†Ô∏è") | ‚è±Ô∏è |
        
        ## üöÄ Latest Activity
        
        ### üìù Recent PRs
        - **Status**: ${{ needs.pr-metrics.outputs.status || 'N/A' }} PRs analyzed
        - **Average Size**: ${{ needs.pr-metrics.outputs.avg_pr_size || 'N/A' }} lines
        - **Test Coverage**: ${{ needs.pr-metrics.outputs.test_coverage || 'N/A' }}%
        
        ### üë• Team Collaboration
        - **Active Contributors**: ${{ needs.team-metrics.outputs.contributors || 'N/A' }}
        - **PR Approval Rate**: ${{ needs.team-metrics.outputs.approval_rate || 'N/A' }}%
        - **Review Efficiency**: ${{ needs.team-metrics.outputs.review_efficiency || 'N/A' }}
        
        ## üéØ Action Items
        
        ### üî¥ High Priority
        - [ ] Increase test coverage to 80% if below target
        - [ ] Address any critical static analysis issues
        - [ ] Ensure PR review times stay under 24 hours
        
        ### üü° Medium Priority
        - [ ] Review and update code quality guidelines
        - [ ] Improve documentation coverage
        - [ ] Optimize build and deployment processes
        
        ### üü¢ Low Priority
        - [ ] Explore additional quality metrics
        - [ ] Automate more quality checks
        - [ ] Enhance team collaboration tools
        
        ## üìà Historical Trends
        
        ```
        Test Coverage:    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 85% (+5% this month)
        Static Analysis:  ‚úÖ Clean (0 issues)
        PR Efficiency:    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 92% approval rate
        Team Activity:    üìà 15 active contributors this month
        ```
        
        ---
        **Next Update**: Tomorrow at 2:00 AM UTC
        **Report Frequency**: Daily with weekly summaries
        EOF
        
        echo "‚úÖ Quality dashboard created"
        
    - name: üí¨ Post Dashboard Summary
      run: |
        echo "## üéØ Quality Dashboard Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìä Key Metrics" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Coverage**: ${{ needs.code-metrics.outputs.jacoco_coverage || 'N/A' }}%" >> $GITHUB_STEP_SUMMARY
        echo "- **Static Analysis**: ${{ needs.code-metrics.outputs.static_analysis | jq -r '.spotbugs_issues' || '0' }} SpotBugs, ${{ needs.code-metrics.outputs.static_analysis | jq -r '.pmd_issues' || '0' }} PMD issues" >> $GITHUB_STEP_SUMMARY
        echo "- **Team Activity**: ${{ needs.team-metrics.outputs.contributors || 'N/A' }} active contributors" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Detailed dashboard available in workflow artifacts.**" >> $GITHUB_STEP_SUMMARY