#!/bin/bash
#
# Pre-commit hook para validar mensajes de commit
# Ubicaci√≥n: .git/hooks/pre-commit
# Formato requerido: <type>(<scope>): <description>
#

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Obtener el mensaje del commit
COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Si es un merge commit, permitirlo autom√°ticamente
if echo "$COMMIT_MSG" | grep -q "^Merge"; then
    echo -e "${GREEN}‚úÖ Merge commit detectado - omitiendo validaci√≥n${NC}"
    exit 0
fi

# ============================================================
# PRIMERO: Bloquear patrones de mensajes autom√°ticos
# ============================================================

# Patrones de mensajes inv√°lidos (autom√°ticos o sospechosos)
AUTOMATIC_PATTERNS=(
    "^Message [0-9]"
    "^Auto-commit"
    "^Automated"
)

# Verificar patrones de mensajes autom√°ticos (PRIORIDAD ALTA)
for pattern in "${AUTOMATIC_PATTERNS[@]}"; do
    if echo "$COMMIT_MSG" | grep -qE "$pattern"; then
        echo -e "${RED}‚ùå Error: Patr√≥n de mensaje autom√°tico detectado${NC}"
        echo -e "${YELLOW}üìù Los mensajes como 'Message XXXXX' no est√°n permitidos${NC}"
        echo -e ""
        echo -e "${YELLOW}üìù Usa el formato Conventional Commits:${NC}"
        echo -e "${YELLOW}   feat(auth): Add login functionality${NC}"
        echo -e "${YELLOW}   fix: Correct memory leak in event handler${NC}"
        echo -e "${YELLOW}   docs: Update API documentation${NC}"
        echo -e ""
        echo -e "${RED}üí° Para forzar el commit, usa: git commit --no-verify${NC}"
        exit 1
    fi
done

# ============================================================
# SEGUNDO: Validar formato Conventional Commits
# ============================================================

# Patr√≥n Conventional Commits: <type>(<scope>): <description>
# Tipos v√°lidos: feat, fix, docs, style, refactor, perf, test, chore, build, ci, revert
CONVENTIONAL_PATTERN="^(feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert)(\([a-z0-9-]+\))?: .+"

if ! echo "$COMMIT_MSG" | grep -qE "$CONVENTIONAL_PATTERN"; then
    echo -e "${RED}‚ùå Error: Formato de mensaje inv√°lido${NC}"
    echo -e ""
    echo -e "${YELLOW}üìù Formato requerido: <type>(<scope>): <description>${NC}"
    echo -e ""
    echo -e "${YELLOW}üìù Tipos v√°lidos:${NC}"
    echo -e "${YELLOW}   - feat:     Nueva funcionalidad${NC}"
    echo -e "${YELLOW}   - fix:      Correcci√≥n de bugs${NC}"
    echo -e "${YELLOW}   - docs:     Documentaci√≥n${NC}"
    echo -e "${YELLOW}   - style:    Formato (puntos y comas, etc.)${NC}"
    echo -e "${YELLOW}   - refactor: Refactorizaci√≥n${NC}"
    echo -e "${YELLOW}   - perf:     Rendimiento${NC}"
    echo -e "${YELLOW}   - test:     Tests${NC}"
    echo -e "${YELLOW}   - chore:    Mantenimiento${NC}"
    echo -e "${YELLOW}   - build:    Build${NC}"
    echo -e "${YELLOW}   - ci:       CI/CD${NC}"
    echo -e "${YELLOW}   - revert:   Revertir commit${NC}"
    echo -e ""
    echo -e "${YELLOW}üìù Ejemplos:${NC}"
    echo -e "${YELLOW}   feat(auth): Add user login functionality${NC}"
    echo -e "${YELLOW}   fix: Correct memory leak in event handler${NC}"
    echo -e "${YELLOW}   docs: Update API documentation for v1.0${NC}"
    echo -e ""
    echo -e "${RED}üí° Para forzar el commit, usa: git commit --no-verify${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ Mensaje de commit v√°lido${NC}"
exit 0
